<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>archicasino</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: linear-gradient(180deg, #0e1724, #0b1320);
      color: #fff;
    }
    .app {
      max-width: 420px;
      min-height: 100vh;
      margin: 0 auto;
      padding: 12px;
      padding-bottom: 86px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 16px;
    }
    .tabs { display: flex; gap: 10px; }
    .pill {
      flex: 1;
      background: #162235;
      border-radius: 14px;
      padding: 10px;
      text-align: center;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }
    .pill.active { box-shadow: inset 0 0 0 2px rgba(74,163,255,0.55); }
    .roulette-wrap {
      background: radial-gradient(circle at center, #18263c, #0f1a2b);
      border-radius: 20px;
      padding: 16px 0 10px;
    }
    .roulette {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 16px;
      padding: 0 16px;
      align-items: center;
      overflow-x: scroll;
      overflow-y: hidden;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
    .roulette::-webkit-scrollbar { display: none; }
    .item {
      flex: 0 0 96px;
      width: 96px;
      background: linear-gradient(180deg, #1b2a40, #0f1a2b);
      border-radius: 16px;
      padding: 12px;
      text-align: center;
      transition: transform 180ms ease, box-shadow 180ms ease;
    }
    .item.win {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 0 0 2px rgba(74,163,255,0.35), 0 0 22px rgba(74,163,255,0.25);
    }
    .media-slot {
      width: 56px;
      height: 56px;
      margin: 0 auto;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .media-img, .media-video {
      width: 56px;
      height: 56px;
      object-fit: contain;
      display: block;
    }
    .price {
      margin-top: 6px;
      font-size: 12px;
      background: #1f324a;
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
    }
    .pointer {
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 10px solid #4aa3ff;
      margin: 8px auto 0;
    }
    .switch {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #162235;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
    }
    .spin {
      background: #5b8ecb;
      border: none;
      border-radius: 14px;
      padding: 14px;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      width: 100%;
    }
    .section {
      margin-top: 8px;
      font-size: 14px;
      opacity: 0.85;
    }

    /* Recent wins */
    .recent {
      background: radial-gradient(circle at center, #18263c, #0f1a2b);
      border-radius: 20px;
      padding: 12px 12px 10px;
    }
    .recent-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight: 900; font-size: 13px; opacity: .95;
      margin-bottom: 10px;
    }
    .recent-list{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding-bottom: 2px;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
    }
    .recent-list::-webkit-scrollbar{display:none;}
    .recent-item{
      flex: 0 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      background:#162235;
      border-radius:14px;
      padding:10px 10px;
      min-width: 240px;
    }
    .rw-avatar{
      width:34px;height:34px;border-radius:50%;object-fit:cover;
      background: rgba(255,255,255,0.12);
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:900;flex:0 0 auto;
    }
    .rw-meta{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .rw-name{font-size:12px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px;}
    .rw-prize{font-size:11px;opacity:.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px;}
    .rw-icon{
      width:34px;height:34px;border-radius:12px;
      background: rgba(255,255,255,0.06);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;flex:0 0 auto;
    }
    .rw-icon .media-img, .rw-icon .media-video{width:34px;height:34px;}

    /* Inventory / Top common */
    .inv {
      background: radial-gradient(circle at center, #18263c, #0f1a2b);
      border-radius: 20px;
      padding: 14px;
    }
    .inv-title {
      font-weight: 800;
      font-size: 14px;
      margin-bottom: 10px;
      opacity: 0.95;
    }
    .inv-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .inv-card {
      background: #162235;
      border-radius: 14px;
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .inv-icon { width:34px; height:34px; border-radius:12px; background: rgba(255,255,255,0.06); display:flex; align-items:center; justify-content:center; overflow:hidden; flex:0 0 auto; }
    .inv-icon .media-img, .inv-icon .media-video { width:34px; height:34px; }

    .lb-avatar{width:34px;height:34px;border-radius:50%;object-fit:cover;background: rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;flex:0 0 auto;}
    .lb-avatar--ph{color: rgba(255,255,255,0.9);}

    .inv-meta { display: flex; flex-direction: column; gap: 2px; min-width:0; }
    .inv-name { font-size: 12px; font-weight: 800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .inv-sub { font-size: 11px; opacity: 0.75; }

    /* Bottom tabs */
    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-width: 420px;
      margin: 0 auto;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid #1f324a;
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
      background: #0b1320;
      z-index: 999;
    }
    .nav {
      font-size: 12px;
      color: #7f93aa;
      text-align: center;
      user-select: none;
      -webkit-user-select: none;
      cursor: pointer;
    }
    .nav.active { color: #4aa3ff; }

    /* Prize claim sheet */
    #claimBackdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 2000;
      pointer-events: auto;
    }
    #claimSheet {
      display: none;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-width: 420px;
      margin: 0 auto;
      background: #0b1320;
      border-top: 1px solid #1f324a;
      border-radius: 18px 18px 0 0;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
      z-index: 2001;
      transform: translateZ(0);
      pointer-events: auto;
    }
    #claimSheet * { pointer-events: auto; }
    .claim-head { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .claim-title { font-weight: 900; font-size: 14px; }
    .claim-close {
      opacity:.85; font-size:14px; padding:6px 10px; border-radius:999px;
      background:#162235; cursor:pointer; user-select:none; -webkit-user-select:none;
    }
    .claim-row { display:flex; gap:12px; align-items:center; }
    .claim-media {
      width:54px; height:54px; border-radius:14px; background:#162235; padding:6px;
      display:flex; align-items:center; justify-content:center; overflow:hidden; flex:0 0 auto;
    }
    .claim-media .media-img, .claim-media .media-video { width:54px; height:54px; }
    .claim-name { font-weight: 900; }
    .claim-meta { font-size:12px; opacity:.8; }
    .claim-actions { display:flex; gap:10px; margin-top:14px; }
    .btn { flex:1; padding:12px; border:0; border-radius:14px; font-weight:900; color:#fff; }
    .btn-sell { background:#5b8ecb; }
    .btn-keep { background:#162235; }
    .claim-hint { margin-top:10px; font-size:12px; opacity:.7; }

    /* Topup sheet */
    #topupBackdrop {
      display:none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 2100;
      pointer-events:auto;
    }
    #topupSheet{
      display:none;
      position: fixed;
      left:0; right:0; bottom:0;
      max-width:420px;
      margin:0 auto;
      background:#0b1320;
      border-top:1px solid #1f324a;
      border-radius:18px 18px 0 0;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
      z-index: 2101;
      transform: translateZ(0);
      pointer-events:auto;
    }
    #topupSheet * { pointer-events:auto; }
    .topup-title { font-weight:900; font-size:14px; }
    .topup-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:12px; }
    .topup-pack {
      background:#162235;
      border-radius:14px;
      padding:12px 10px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      font-weight:900;
    }
    .topup-pack small { display:block; font-weight:700; opacity:.75; margin-top:4px; font-size:11px; }
    .topup-footer { margin-top:12px; display:flex; gap:10px; }
    .topup-cancel { background:#162235; }
    .topup-buy { background:#5b8ecb; }
    .topup-note { margin-top:10px; font-size:12px; opacity:.7; }

    /* Hide iOS webkit video overlays (play icon) */
    .media-video, .prize-video { pointer-events: none; }
    video::-webkit-media-controls { display:none !important; }
    video::-webkit-media-controls-panel { display:none !important; }
    video::-webkit-media-controls-start-playback-button { display:none !important; }
    video::-webkit-media-controls-play-button { display:none !important; }
  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <div>archicasino</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div id="balanceBadge" style="font-weight:800;font-size:13px;background:#162235;padding:6px 10px;border-radius:999px;">‚≠ê ‚Ä¶</div>
        <div id="topupBtn" style="font-weight:900;font-size:13px;background:#5b8ecb;padding:6px 10px;border-radius:999px;cursor:pointer;user-select:none;-webkit-user-select:none;">
          ‚ûï
        </div>
      </div>
    </div>

    <div class="recent" id="recentCard">
      <div class="recent-head">
        <div>üî• –ù–µ–¥–∞–≤–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–∏</div>
        <div id="recentStatus" style="font-size:12px;opacity:.7;"></div>
      </div>
      <div class="recent-list" id="recentList"></div>
    </div>

    <div id="screenRoulette">

      <div class="tabs">
        <div class="pill active" data-cost="25">25 ‚≠ê</div>
        <div class="pill" data-cost="50">50 ‚≠ê</div>
      </div>

      <div class="roulette-wrap">
        <div class="roulette" id="roulette" data-initialized="false">
          <!-- items are loaded from /prizes -->
        </div>
        <div class="pointer"></div>
      </div>

      <div class="switch">–î–µ–º–æ —Ä–µ–∂–∏–º <input type="checkbox"></div>
      <button class="spin" id="spinBtn">–ú–Ω–µ –ø–æ–≤–µ–∑—ë—Ç! üé∞</button>
    </div>

    <div id="screenInventory" style="display:none;">
      <div class="inv">
        <div class="inv-title">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
        <div id="inventoryEmpty" class="section" style="margin:0;">–ü–æ–∫–∞ –ø—É—Å—Ç–æ ‚Äî –∫—Ä—É—Ç–∏ —Ä—É–ª–µ—Ç–∫—É üòä</div>
        <div id="inventoryList" class="inv-list" style="display:none;"></div>
      </div>
    </div>

    <div id="screenTop" style="display:none;">
      <div class="inv">
        <div class="inv-title">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
        <div id="topMe" class="section" style="margin:0 0 10px 0;">‚Äî</div>
        <div id="topList" class="inv-list" style="grid-template-columns: 1fr;"></div>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav active" id="tabSpin">üé∞ –†—É–ª–µ—Ç–∫–∞</div>
    <div class="nav" id="tabInv">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
    <div class="nav" id="tabTop">üèÜ –¢–æ–ø</div>
  </div>

  <!-- Claim UI -->
  <div id="claimBackdrop"></div>
  <div id="claimSheet">
    <div class="claim-head">
      <div class="claim-title">üéâ –í–∞—à –ø—Ä–∏–∑</div>
      <div class="claim-close" id="claimClose">‚úï</div>
    </div>

    <div class="claim-row">
      <div id="claimMedia" class="claim-media"></div>
      <div style="display:flex; flex-direction:column; gap:4px;">
        <div id="claimName" class="claim-name">‚Äî</div>
        <div id="claimMeta" class="claim-meta">‚Äî</div>
      </div>
    </div>

    <div class="claim-actions">
      <button class="btn btn-sell" id="btnSell">–ü—Ä–æ–¥–∞—Ç—å</button>
      <button class="btn btn-keep" id="btnKeep">–ó–∞–±—Ä–∞—Ç—å</button>
    </div>

    <div class="claim-hint">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: –ø—Ä–æ–¥–∞—Ç—å –∑–∞ ‚≠ê –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.</div>
  </div>

  <!-- Topup UI -->
  <div id="topupBackdrop"></div>
  <div id="topupSheet">
    <div class="claim-head" style="margin-bottom:6px;">
      <div class="topup-title">‚≠ê –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
      <div class="claim-close" id="topupClose">‚úï</div>
    </div>

    <div class="topup-grid">
      <div class="topup-pack" data-stars="50">50 ‚≠ê<small>–±—ã—Å—Ç—Ä–æ</small></div>
      <div class="topup-pack" data-stars="100">100 ‚≠ê<small>–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ</small></div>
      <div class="topup-pack" data-stars="250">250 ‚≠ê<small>–≤—ã–≥–æ–¥–Ω–æ</small></div>
    </div>

    <div class="topup-footer">
      <button class="btn topup-cancel" id="topupCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn topup-buy" id="topupBuy" disabled>–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
    </div>

    <div class="topup-note">–û–ø–ª–∞—Ç–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ Telegram. –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞.</div>
  </div>

  <script>
    const API_BASE = "https://test-u2mr.onrender.com"; // <-- –¥–æ–ª–∂–µ–Ω —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –≤–∞—à –±—ç–∫–µ–Ω–¥

    const tg = window.Telegram?.WebApp;
    try { tg?.ready(); } catch (_) {}

    const btn = document.getElementById('spinBtn');
    const roulette = document.getElementById('roulette');
    const balanceBadge = document.getElementById('balanceBadge');

    const recentList = document.getElementById('recentList');
    const recentStatus = document.getElementById('recentStatus');

    const topupBtn = document.getElementById('topupBtn');
    const topupBackdrop = document.getElementById('topupBackdrop');
    const topupSheet = document.getElementById('topupSheet');
    const topupClose = document.getElementById('topupClose');
    const topupCancel = document.getElementById('topupCancel');
    const topupBuy = document.getElementById('topupBuy');
    const topupPacks = Array.from(document.querySelectorAll('.topup-pack[data-stars]'));
    let selectedTopupStars = null;
    let topupInFlight = false;

    const screenRoulette = document.getElementById('screenRoulette');
    const screenInventory = document.getElementById('screenInventory');
    const screenTop = document.getElementById('screenTop');

    const tabSpin = document.getElementById('tabSpin');
    const tabInv = document.getElementById('tabInv');
    const tabTop = document.getElementById('tabTop');

    const inventoryList = document.getElementById('inventoryList');
    const inventoryEmpty = document.getElementById('inventoryEmpty');

    const topList = document.getElementById('topList');
    const topMe = document.getElementById('topMe');

    const claimBackdrop = document.getElementById('claimBackdrop');
    const claimSheet = document.getElementById('claimSheet');
    const claimClose = document.getElementById('claimClose');
    const claimMedia = document.getElementById('claimMedia');
    const claimName = document.getElementById('claimName');
    const claimMeta = document.getElementById('claimMeta');
    const btnSell = document.getElementById('btnSell');
    const btnKeep = document.getElementById('btnKeep');

    const pills = Array.from(document.querySelectorAll('.pill[data-cost]'));
    let selectedCost = 25;

    let pendingSpinId = null;
    let pendingPrize = null;

    const prizeMap = new Map(); // id -> {id,name,cost,icon_url}

    pills.forEach(p => p.addEventListener('click', () => {
      pills.forEach(x => x.classList.remove('active'));
      p.classList.add('active');
      selectedCost = parseInt(p.dataset.cost, 10) || 25;
      try { tg?.HapticFeedback?.selectionChanged(); } catch (_) {}
    }));

    async function apiPost(path, payload) {
      const res = await fetch(`${API_BASE}${path}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      return await res.json();
    }

    async function apiGet(path) {
      const res = await fetch(`${API_BASE}${path}`, { method: 'GET' });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      return await res.json();
    }

    function isWebm(url) { return /\.webm(\?|$)/i.test(String(url || '')); }
    function posterFromWebm(url) {
      if (!url) return '';
      return String(url).replace(/\.webm(\?.*)?$/i, '.webp$1');
    }

    function fallbackEmojiUrlById(id) {
      const map = {
        1: 'https://emojiapi.dev/api/v1/heart_with_ribbon/128.png',
        2: 'https://emojiapi.dev/api/v1/teddy_bear/128.png',
        3: 'https://emojiapi.dev/api/v1/birthday_cake/128.png',
        4: 'https://emojiapi.dev/api/v1/gem_stone/128.png',
        5: 'https://emojiapi.dev/api/v1/rose/128.png'
      };
      return map[id] || map[1];
    }

    function resolveIconUrl(prizeId, iconUrl) {
      if (iconUrl) return iconUrl;
      const p = prizeMap.get(Number(prizeId));
      if (p?.icon_url) return p.icon_url;
      return fallbackEmojiUrlById(prizeId);
    }

    function mediaHTML(url, cls, posterUrl) {
      const safeUrl = String(url || '');
      const poster = posterUrl || (isWebm(safeUrl) ? posterFromWebm(safeUrl) : '');
      if (isWebm(safeUrl)) {
        return `<video class="media-video ${cls || ''}" autoplay muted loop playsinline webkit-playsinline preload="auto" disablepictureinpicture controlslist="nodownload noplaybackrate noremoteplayback" ${poster ? `poster="${poster}"` : ''}>
          <source src="${safeUrl}" type="video/webm">
        </video>`;
      }
      return `<img class="media-img ${cls || ''}" src="${safeUrl}" alt="icon" loading="lazy" decoding="async">`;
    }

    function kickVideos(root=document) {
      const vids = root.querySelectorAll('video.media-video');
      vids.forEach(v => {
        try {
          v.controls = false;
          v.removeAttribute('controls');
          v.muted = true;
          v.defaultMuted = true;
          v.loop = true;
          v.autoplay = true;
          v.playsInline = true;
          v.setAttribute('playsinline', '');
          v.setAttribute('webkit-playsinline', '');
          v.disablePictureInPicture = true;
          v.setAttribute('disablepictureinpicture', '');
          // iOS: –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å
          const p = v.play();
          if (p && typeof p.catch === 'function') p.catch(()=>{});
        } catch (_) {}
      });
    }

    function avatarHTML(url, name, cls='lb-avatar') {
      const safeName = String(name || '').trim();
      if (url) {
        return `<img class="${cls}" src="${url}" alt="avatar" referrerpolicy="no-referrer">`;
      }
      const initials = safeName ? safeName.split(/\s+/).slice(0,2).map(s => s[0]?.toUpperCase()).join('') : 'U';
      return `<div class="${cls} lb-avatar--ph">${initials || 'U'}</div>`;
    }

    async function refreshBalance() {
      try {
        const me = await apiPost('/me', { initData: tg?.initData || '' });
        if (balanceBadge) balanceBadge.textContent = `‚≠ê ${me.balance}`;
      } catch (_) {
        if (balanceBadge) balanceBadge.textContent = '‚≠ê ‚Äî';
      }
    }

    async function refreshPrizes() {
      if (!roulette) return;
      try {
        const res = await apiGet('/prizes');
        const items = Array.isArray(res.items) ? res.items : [];
        prizeMap.clear();
        items.forEach(p => prizeMap.set(Number(p.id), p));

        // render roulette base strip
        roulette.innerHTML = items.map(p => {
          const icon = resolveIconUrl(p.id, p.icon_url);
          return `
            <div class="item" data-id="${p.id}">
              <div class="media-slot">${mediaHTML(icon, '', '')}</div>
              <div class="price">‚≠ê ${p.cost}</div>
            </div>
          `;
        }).join('');

        roulette.dataset.initialized = 'false';
        initInfiniteRoulette();
        kickVideos(roulette);
      } catch (e) {
        // fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ 5 –ø—Ä–∏–∑–æ–≤, –µ—Å–ª–∏ /prizes –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        const fallback = [1,2,4,3,5].map(id => ({
          id, cost: (id===1?15:id===2?25:id===3?50:id===4?100:25),
          icon_url: fallbackEmojiUrlById(id)
        }));
        roulette.innerHTML = fallback.map(p => `
          <div class="item" data-id="${p.id}">
            <div class="media-slot">${mediaHTML(p.icon_url, '', '')}</div>
            <div class="price">‚≠ê ${p.cost}</div>
          </div>
        `).join('');
        roulette.dataset.initialized = 'false';
        initInfiniteRoulette();
        kickVideos(roulette);
      }
    }

    async function refreshInventory() {
      if (!inventoryList || !inventoryEmpty) return;
      try {
        const inv = await apiPost('/inventory', { initData: tg?.initData || '' });
        const items = Array.isArray(inv.items) ? inv.items : [];

        if (!items.length) {
          inventoryEmpty.style.display = '';
          inventoryList.style.display = 'none';
          inventoryList.innerHTML = '';
          return;
        }

        inventoryEmpty.style.display = 'none';
        inventoryList.style.display = '';
        inventoryList.innerHTML = items.map(it => {
          const icon = resolveIconUrl(it.prize_id, it.icon_url);
          const name = it.prize_name || it.name || '–ü–æ–¥–∞—Ä–æ–∫';
          const cost = it.prize_cost ?? it.cost ?? '';
          const when = it.created_at ? new Date(it.created_at * 1000).toLocaleString() : '';
          return `
            <div class="inv-card">
              <div class="inv-icon">${mediaHTML(icon, '', '')}</div>
              <div class="inv-meta">
                <div class="inv-name">${name}</div>
                <div class="inv-sub">‚≠ê ${cost} ${when ? '‚Ä¢ ' + when : ''}</div>
              </div>
            </div>
          `;
        }).join('');
        kickVideos(inventoryList);
      } catch (_) {
        inventoryEmpty.style.display = '';
        inventoryList.style.display = 'none';
        inventoryList.innerHTML = '';
      }
    }

    async function refreshLeaderboard() {
      if (!topList || !topMe) return;

      topMe.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      topList.innerHTML = '';

      try {
        const res = await apiPost('/leaderboard', { initData: tg?.initData || '', limit: 30 });
        const items = Array.isArray(res.items) ? res.items : [];
        const me = res.me || {};

        topMe.textContent = `–í–∞—à–µ –º–µ—Å—Ç–æ: #${me.rank ?? '‚Äî'} ‚Ä¢ –ë–∞–ª–∞–Ω—Å: ‚≠ê ${me.balance ?? '‚Äî'}`;

        topList.innerHTML = items.map(it => {
          const badge = it.is_me ? ' style="box-shadow: inset 0 0 0 2px rgba(74,163,255,0.55)"' : '';
          const av = avatarHTML(it.avatar, it.name, 'lb-avatar');
          return `
            <div class="inv-card"${badge}>
              ${av}
              <div class="inv-meta" style="width:100%;">
                <div class="inv-name">#${it.rank} ‚Ä¢ ${it.name}</div>
                <div class="inv-sub">‚≠ê ${it.balance}</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (_) {
        topMe.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞';
        topList.innerHTML = '';
      }
    }

    async function refreshRecentWins() {
      if (!recentList) return;
      try {
        const res = await apiPost('/recent_wins', { initData: tg?.initData || '' });
        const items = Array.isArray(res.items) ? res.items : [];
        recentList.innerHTML = items.slice(0, 20).map(w => {
          const av = avatarHTML(w.avatar, w.name, 'rw-avatar');
          const icon = resolveIconUrl(w.prize_id, w.icon_url);
          return `
            <div class="recent-item">
              ${av}
              <div class="rw-meta">
                <div class="rw-name">${w.name}</div>
                <div class="rw-prize">${w.prize_name} ‚Ä¢ ‚≠ê ${w.prize_cost}</div>
              </div>
              <div class="rw-icon">${mediaHTML(icon, '', '')}</div>
            </div>
          `;
        }).join('');
        kickVideos(recentList);
        if (recentStatus) recentStatus.textContent = '';
      } catch (e) {
        if (recentStatus) recentStatus.textContent = '–æ—à–∏–±–∫–∞';
      }
    }

    function setTab(which) {
      const isInv = which === 'inv';
      const isTop = which === 'top';

      if (screenRoulette) screenRoulette.style.display = (isInv || isTop) ? 'none' : '';
      if (screenInventory) screenInventory.style.display = isInv ? '' : 'none';
      if (screenTop) screenTop.style.display = isTop ? '' : 'none';

      tabSpin?.classList.toggle('active', !isInv && !isTop);
      tabInv?.classList.toggle('active', isInv);
      tabTop?.classList.toggle('active', isTop);

      if (isInv) refreshInventory();
      if (isTop) refreshLeaderboard();
    }

    tabSpin?.addEventListener('click', () => setTab('spin'));
    tabInv?.addEventListener('click', () => setTab('inv'));
    tabTop?.addEventListener('click', () => setTab('top'));

    // ===== Topup =====
    function openTopup() {
      selectedTopupStars = null;
      topupPacks.forEach(p => p.style.boxShadow = '');
      if (topupBuy) topupBuy.disabled = true;

      topupBackdrop.style.display = 'block';
      topupSheet.style.display = 'block';
      try { tg?.HapticFeedback?.selectionChanged(); } catch (_) {}
    }

    function closeTopup() {
      if (topupInFlight) return;
      topupBackdrop.style.display = 'none';
      topupSheet.style.display = 'none';
    }

    function openInvoiceSmart(link) {
      try {
        if (tg?.openInvoice) {
          tg.openInvoice(link, (status) => {
            if (status === 'paid' || status === 'pending') {
              setTimeout(refreshBalance, 800);
              setTimeout(refreshBalance, 2000);
              setTimeout(refreshBalance, 5000);
            }
          });
          return;
        }
      } catch (_) {}

      try {
        if (tg?.openTelegramLink && /^https?:\/\/t\.me\//i.test(link)) {
          tg.openTelegramLink(link);
          return;
        }
        if (tg?.openLink) {
          tg.openLink(link);
          return;
        }
      } catch (_) {}

      window.open(link, "_blank");
    }

    async function doTopup(stars) {
      if (topupInFlight) return;
      topupInFlight = true;
      if (topupBuy) topupBuy.disabled = true;

      try {
        const res = await apiPost('/topup/create', { initData: tg?.initData || '', stars });
        const link = res?.invoice_link;
        if (!link) throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª invoice_link. –ü—Ä–æ–≤–µ—Ä—å BOT_TOKEN –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.');

        openInvoiceSmart(link);
        closeTopup();
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ' + (e?.message || e));
      } finally {
        topupInFlight = false;
        if (topupBuy) topupBuy.disabled = !(selectedTopupStars > 0);
      }
    }

    topupBtn?.addEventListener('click', openTopup);
    topupBtn?.addEventListener('touchend', (e) => { e.preventDefault(); openTopup(); }, { passive: false });

    topupClose?.addEventListener('click', closeTopup);
    topupClose?.addEventListener('touchend', (e) => { e.preventDefault(); closeTopup(); }, { passive: false });

    topupCancel?.addEventListener('click', closeTopup);
    topupCancel?.addEventListener('touchend', (e) => { e.preventDefault(); closeTopup(); }, { passive: false });

    topupBackdrop.onclick = (e) => { try { e.preventDefault(); } catch (_) {} closeTopup(); };

    topupPacks.forEach(p => {
      const pick = () => {
        if (topupInFlight) return;
        topupPacks.forEach(x => x.style.boxShadow = '');
        p.style.boxShadow = 'inset 0 0 0 2px rgba(74,163,255,0.55)';
        selectedTopupStars = parseInt(p.dataset.stars, 10) || null;
        if (topupBuy) topupBuy.disabled = !(selectedTopupStars > 0);
        try { tg?.HapticFeedback?.selectionChanged(); } catch (_) {}
      };
      p.addEventListener('click', pick);
      p.addEventListener('touchend', (e) => { e.preventDefault(); pick(); }, { passive: false });
    });

    topupBuy?.addEventListener('click', () => selectedTopupStars && doTopup(selectedTopupStars));
    topupBuy?.addEventListener('touchend', (e) => { e.preventDefault(); selectedTopupStars && doTopup(selectedTopupStars); }, { passive: false });

    // ===== Claim (prize) =====
    function openClaim(prize) {
      pendingPrize = prize;
      pendingSpinId = prize.spin_id || prize.spinId || prize.spinID || null;

      if (!pendingSpinId) {
        alert('–û—à–∏–±–∫–∞: /spin –Ω–µ –≤–µ—Ä–Ω—É–ª spin_id. –û–±–Ω–æ–≤–∏ –±—ç–∫–µ–Ω–¥ /spin.');
        btn.disabled = false;
        pendingPrize = null;
        return;
      }

      const icon = resolveIconUrl(prize.id, prize.icon_url);
      claimMedia.innerHTML = mediaHTML(icon, '', '');
      kickVideos(claimMedia);

      claimName.textContent = prize.name || '–ü–æ–¥–∞—Ä–æ–∫';
      claimMeta.textContent = `–ü—Ä–æ–¥–∞—Ç—å –∑–∞ ‚≠ê ${prize.cost} –∏–ª–∏ –∑–∞–±—Ä–∞—Ç—å –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å`;

      claimBackdrop.style.display = 'block';
      claimSheet.style.display = 'block';

      claimBackdrop.onclick = (e) => { try { e.preventDefault(); } catch (_) {} };
      try { tg?.HapticFeedback?.notificationOccurred('success'); } catch (_) {}
    }

    function closeClaimIfAllowed() {
      claimBackdrop.style.display = 'none';
      claimSheet.style.display = 'none';
      setTimeout(() => {
        if (pendingSpinId) {
          claimBackdrop.style.display = 'block';
          claimSheet.style.display = 'block';
        }
      }, 50);
    }

    claimClose.addEventListener('click', closeClaimIfAllowed);
    claimClose.addEventListener('touchend', (e) => { e.preventDefault(); closeClaimIfAllowed(); }, { passive: false });

    async function doClaim(action) {
      btnSell.disabled = true;
      btnKeep.disabled = true;

      try {
        const res = await apiPost('/claim', {
          initData: tg?.initData || '',
          spin_id: pendingSpinId,
          action
        });

        if (balanceBadge && res && typeof res.balance === 'number') {
          balanceBadge.textContent = `‚≠ê ${res.balance}`;
        } else {
          refreshBalance();
        }

        if (action === 'keep') {
          await refreshInventory();
        }

        claimBackdrop.style.display = 'none';
        claimSheet.style.display = 'none';

        pendingSpinId = null;
        pendingPrize = null;
        btn.disabled = false;

        refreshRecentWins();

      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
      } finally {
        btnSell.disabled = false;
        btnKeep.disabled = false;
      }
    }

    const onSell = (e) => { try { e.preventDefault(); e.stopPropagation(); } catch (_) {} doClaim('sell'); };
    const onKeep = (e) => { try { e.preventDefault(); e.stopPropagation(); } catch (_) {} doClaim('keep'); };

    btnSell.addEventListener('click', onSell);
    btnSell.addEventListener('touchend', onSell, { passive: false });

    btnKeep.addEventListener('click', onKeep);
    btnKeep.addEventListener('touchend', onKeep, { passive: false });

    // ===== Infinite roulette =====
    const r = roulette || document.querySelector('.roulette');

    function initInfiniteRoulette() {
      if (!r || r.dataset.initialized === 'true') return;

      const items = Array.from(r.children);
      if (!items.length) return;

      items.forEach(el => r.appendChild(el.cloneNode(true)));
      items.forEach(el => r.appendChild(el.cloneNode(true)));

      r._third = () => r.scrollWidth / 3;
      requestAnimationFrame(() => { r.scrollLeft = r._third(); });

      r.dataset.initialized = 'true';
      kickVideos(r);
    }

    function normalizeInfinite() {
      if (!r || r.dataset.initialized !== 'true') return 0;
      const third = r._third ? r._third() : (r.scrollWidth / 3);
      if (!third) return 0;

      if (r.scrollLeft < third * 0.35) { r.scrollLeft += third; return third; }
      if (r.scrollLeft > third * 1.65) { r.scrollLeft -= third; return -third; }
      return 0;
    }

    function pickForwardTarget(prizeId) {
      const items = Array.from(r.querySelectorAll('.item'));
      const candidates = items.filter(i => i.dataset.id == prizeId);
      if (!candidates.length) return null;

      const viewportCenter = r.scrollLeft + (r.clientWidth / 2);
      const minLeadPx = r.clientWidth * 0.9;

      let target = null;
      let best = Infinity;

      for (const c of candidates) {
        const center = c.offsetLeft + (c.clientWidth / 2);
        const delta = center - viewportCenter;
        if (delta >= minLeadPx && delta < best) { best = delta; target = c; }
      }

      if (!target) {
        r.scrollLeft += r.scrollWidth / 3;
        const vc2 = r.scrollLeft + (r.clientWidth / 2);
        best = Infinity;
        for (const c of candidates) {
          const center = c.offsetLeft + (c.clientWidth / 2);
          const delta = center - vc2;
          if (delta >= 0 && delta < best) { best = delta; target = c; }
        }
      }

      return target || candidates[0];
    }

    function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

    async function spinToPrize(prize) {
      initInfiniteRoulette();

      r.dataset.lockScroll = 'true';
      r.style.pointerEvents = 'none';

      r.querySelectorAll('.item.win').forEach(el => el.classList.remove('win'));

      const SPIN_MS = 2200;
      const speed = 1.35;
      let startScroll = r.scrollLeft;
      const spinDistance = SPIN_MS * speed;

      await new Promise((resolve) => {
        const t0 = performance.now();
        const tick = (now) => {
          const p = Math.min(1, (now - t0) / SPIN_MS);
          r.scrollLeft = startScroll + spinDistance * p;
          const shift = normalizeInfinite();
          if (shift) startScroll += shift;
          if (p < 1) requestAnimationFrame(tick);
          else resolve();
        };
        requestAnimationFrame(tick);
      });

      const target = pickForwardTarget(prize.id);
      if (!target) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω item –¥–ª—è –ø—Ä–∏–∑–∞');

      let to = (target.offsetLeft + target.clientWidth / 2) - (r.clientWidth / 2);
      let from = r.scrollLeft;
      const STOP_MS = 1600;

      await new Promise((resolve) => {
        const t1 = performance.now();
        const tick = (now) => {
          const p = Math.min(1, (now - t1) / STOP_MS);
          r.scrollLeft = from + (to - from) * easeOutCubic(p);
          const shift = normalizeInfinite();
          if (shift) { from += shift; to += shift; }
          if (p < 1) requestAnimationFrame(tick);
          else resolve();
        };
        requestAnimationFrame(tick);
      });

      target.classList.add('win');
      try { tg?.HapticFeedback?.notificationOccurred('success'); } catch (_) {}

      r.dataset.lockScroll = 'false';
      r.style.pointerEvents = '';
    }

    if (btn && r) {
      const blockScroll = (e) => { try { e.preventDefault(); } catch (_) {} };
      r.addEventListener('touchstart', blockScroll, { passive: false });
      r.addEventListener('touchmove', blockScroll, { passive: false });
      r.addEventListener('wheel', blockScroll, { passive: false });

      btn.addEventListener('click', async () => {
        // user gesture: –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –≤–∏–¥–µ–æ, —á—Ç–æ–±—ã iOS –Ω–µ —Ä–∏—Å–æ–≤–∞–ª play overlay
        kickVideos(document);

        if (pendingSpinId && pendingPrize) {
          openClaim(pendingPrize);
          return;
        }

        btn.disabled = true;
        try {
          const prize = await apiPost('/spin', { initData: tg?.initData || '', cost: selectedCost });

          if (balanceBadge && prize && typeof prize.balance === 'number') {
            balanceBadge.textContent = `‚≠ê ${prize.balance}`;
          }

          await spinToPrize(prize);
          openClaim(prize);

          refreshRecentWins();

        } catch (e) {
          alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
          btn.disabled = false;
          r.dataset.lockScroll = 'false';
          r.style.pointerEvents = '';
        }
      });

      // start
      refreshBalance();
      refreshPrizes().then(() => initInfiniteRoulette());
      refreshInventory();
      refreshRecentWins();
      setInterval(refreshRecentWins, 12000);
      setTab('spin');
    } else {
      console.warn('spinBtn –∏–ª–∏ roulette –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
    }
  </script>
</body>
</html>
