<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>archicasino</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: linear-gradient(180deg, #0e1724, #0b1320);
      color: #fff;
    }
    
    :root{ --block-gap: 4px; }
.app {
      max-width: 420px;
      min-height: 100vh;
      margin: 0 auto;
      padding: 12px;
      padding-bottom: 108px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 16px;
    }
    .tabs { display: flex; gap: 10px; }
    .pill {
      flex: 1;
      background: #162235;
      border-radius: 14px;
      padding: 10px;
      text-align: center;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }
    .pill.active { box-shadow: inset 0 0 0 2px rgba(74,163,255,0.55); }

    /* Cases gallery (big cover + name + price) */
    .cases-grid{
      display: flex;
      gap: 10px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: 2px;
      scroll-snap-type: x mandatory;
    }
    .cases-grid::-webkit-scrollbar{ display:none; }
    .case-card{
      position: relative;
      overflow: hidden;
      border-radius: 18px;
      padding: 10px;
      background: radial-gradient(circle at 35% 0%, rgba(91,142,203,.22), rgba(22,34,53,.92));
      border: 1px solid rgba(255,255,255,0.10);
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      min-height: 170px;
      flex: 0 0 186px;
      scroll-snap-align: start;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .case-card.active{
      border-color: rgba(74,163,255,0.45);
      box-shadow: 0 0 0 2px rgba(74,163,255,0.22), 0 0 22px rgba(74,163,255,0.14);
    }
    .case-cover{
      width: 100%;
      height: 110px;
      object-fit: contain;
      border-radius: 14px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .case-name{
      font-weight: 900;
      font-size: 13px;
      text-align: center;
      margin-top: 2px;
      line-height: 1.15;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .case-price{
      background: #f0a54b;
      color: #1a1208;
      font-weight: 900;
      border-radius: 12px;
      padding: 8px 10px;
      min-width: 86px;
      text-align: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.18);
    }
    @media (max-width: 360px){
      .case-card{ flex-basis: 86%; }
    }
    .roulette-wrap {
      background: radial-gradient(circle at center, #18263c, #0f1a2b);
      border-radius: 20px;
      padding: 16px 0 10px;
    }
    .roulette {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 16px;
      padding: 0 16px;
      align-items: center;
      overflow-x: scroll;
      overflow-y: hidden;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
    .roulette::-webkit-scrollbar { display: none; }
    .item {
      flex: 0 0 96px;
      width: 96px;
      background: linear-gradient(180deg, #1b2a40, #0f1a2b);
      border-radius: 16px;
      padding: 12px;
      text-align: center;
      transition: transform 180ms ease, box-shadow 180ms ease;
    }
    .item.win {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 0 0 2px rgba(74,163,255,0.35), 0 0 22px rgba(74,163,255,0.25);
    }
    .item img { width: 56px; height: 56px; }
    .price {
      margin-top: 6px;
      font-size: 12px;
      background: #1f324a;
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
    }
    .pointer {
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 10px solid #4aa3ff;
      margin: 8px auto 0;
    }
    .switch {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #162235;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
    }
    .spin {
      background: #5b8ecb;
      border: none;
      border-radius: 14px;
      padding: 14px;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      width: 100%;
    }
    .section {
      margin-top: 8px;
      font-size: 14px;
      opacity: 0.85;
    }


    /* Global small spacing between main blocks so they don't visually merge */
    #screenRoulette{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    #screenRoulette > .recent-wins{ margin: 0; }
    #screenRoulette > .case-hint{ margin-top: 0; }

    /* Inventory / Top common */
    .inv {
      background: radial-gradient(circle at center, #18263c, #0f1a2b);
      border-radius: 20px;
      padding: 14px;
    }
    .inv-title {
      font-weight: 900;
      font-size: 16px;
      margin-bottom: 12px;
      opacity: 0.98;
      text-align: center;
    }
    .inv-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .inv-card {
      background: #162235;
      border-radius: 14px;
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .inv-card img { width: 34px; height: 34px; }
    .lb-avatar{width:34px;height:34px;border-radius:50%;object-fit:cover;background: rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;flex:0 0 auto;}
    .lb-avatar--ph{color: rgba(255,255,255,0.9);}

    .inv-meta { display: flex; flex-direction: column; gap: 2px; }
    .inv-name { font-size: 12px; font-weight: 800; }
    .inv-sub { font-size: 11px; opacity: 0.75; }


    .inv-empty-card{
      background: #232f41;
      border-radius: 18px;
      padding: 22px 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      min-height: 140px;
    }
    .inv-empty-ico{opacity:.95;}
    .inv-empty-text{
      font-weight: 800;
      font-size: 14px;
      opacity: 0.95;
      text-align: center;
      line-height: 1.2;
    }
    /* Bottom tabs */
    .bottom-nav{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(12px + env(safe-area-inset-bottom));
      width: min(420px, calc(100% - 24px));
      display: flex;
      gap: 6px;
      padding: 8px;
      border-radius: 26px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 26px rgba(0,0,0,0.35);
      z-index: 999;
    }
    .nav{
      flex: 1;
      height: 58px;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 600;
      color: rgba(231,241,255,0.70);
      text-align: center;
      user-select: none;
      -webkit-user-select: none;
      cursor: pointer;
      transition: background .15s ease, color .15s ease, transform .15s ease;
    }
    .nav:active{ transform: scale(0.98); }
    .nav .nav-icon{ font-size: 22px; line-height: 1; }
    .nav .nav-label{ line-height: 1.1; letter-spacing: .1px; }
    .nav.active{
      background: rgba(74,163,255,0.14);
      border: 1px solid rgba(74,163,255,0.28);
      color: #eaf2ff;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
    }

    /* Prize claim sheet */
    #claimBackdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 2000;
      pointer-events: auto;
    }
    #claimSheet {
      display: none;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-width: 420px;
      margin: 0 auto;
      background: #0b1320;
      border-top: 1px solid #1f324a;
      border-radius: 18px 18px 0 0;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
      z-index: 2001;
      transform: translateZ(0);
      pointer-events: auto;
    }
    #claimSheet * { pointer-events: auto; }
    .claim-head { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .claim-title { font-weight: 900; font-size: 14px; }
    .claim-close {
      opacity:.85; font-size:14px; padding:6px 10px; border-radius:999px;
      background:#162235; cursor:pointer; user-select:none; -webkit-user-select:none;
    }
    .claim-row { display:flex; gap:12px; align-items:center; }
    .claim-row img { width:54px; height:54px; border-radius:14px; background:#162235; padding:6px; }
    .claim-name { font-weight: 900; }
    .claim-meta { font-size:12px; opacity:.8; }
    .claim-actions { display:flex; gap:10px; margin-top:14px; }
    .btn { flex:1; padding:12px; border:0; border-radius:14px; font-weight:900; color:#fff; }
    .btn-sell { background:#5b8ecb; }
    .btn-keep { background:#162235; }
    .claim-hint { margin-top:10px; font-size:12px; opacity:.7; }

    /* Topup sheet */
    #topupBackdrop {
      display:none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 2100;
      pointer-events:auto;
    }
    #topupSheet{
      display:none;
      position: fixed;
      left:0; right:0; bottom:0;
      max-width:420px;
      margin:0 auto;
      background:#0b1320;
      border-top:1px solid #1f324a;
      border-radius:18px 18px 0 0;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
      z-index: 2101;
      transform: translateZ(0);
      pointer-events:auto;
    }
    #topupSheet * { pointer-events:auto; }
    .topup-title { font-weight:900; font-size:14px; }
    .topup-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:12px; }
    .topup-pack {
      background:#162235;
      border-radius:14px;
      padding:12px 10px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      font-weight:900;
    }
    .topup-pack small { display:block; font-weight:700; opacity:.75; margin-top:4px; font-size:11px; }
    .topup-footer { margin-top:12px; display:flex; gap:10px; }
    .topup-cancel { background:#162235; }
    .topup-buy { background:#5b8ecb; }
    .topup-note { margin-top:10px; font-size:12px; opacity:.7; }

    /* Recent wins */
    .recent-wins{
      margin: 10px 0 0;
      padding: 10px 10px;
      border-radius: 14px;
      background: #162235;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .recent-wins__title{
      font-size: 13px;
      opacity: .85;
      margin-bottom: 8px;
      font-weight: 900;
      text-align: center;
    }
    .recent-wins__list{
      display: flex;
      gap: 10px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .recent-wins__list::-webkit-scrollbar{ display:none; }
    .recent-win{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.08);
      white-space: nowrap;
      flex: 0 0 auto;
      user-select: none;
      -webkit-user-select: none;
    }
    .recent-win__avatar{
      width: 26px;
      height: 26px;
      border-radius: 50%;
      object-fit: cover;
      background: rgba(255,255,255,0.12);
      display: block;
      flex: 0 0 auto;
    }
    .recent-win__avatar--ph{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 11px;
      font-weight: 900;
      color: rgba(255,255,255,0.9);
    }
    .recent-win__meta{display:flex;flex-direction:column;gap:2px;line-height:1.05;}
    .recent-win__name{font-size: 13px; max-width: 170px; overflow: hidden; text-overflow: ellipsis;}
    .recent-win__prize{font-size: 11px; opacity: .75; max-width: 170px; overflow: hidden; text-overflow: ellipsis; display:flex; align-items:center;}

  
    .recent-win__prize-icon{width:14px;height:14px;border-radius:3px;object-fit:cover;margin-right:6px;vertical-align:middle;}

  
    .case-hint{
      margin-top:10px;
      opacity:.85;
      font-size:13px;
          display:none;
}
    .inv-actions{
      margin-top:8px;
      display:flex;
      gap:8px;
    }
    .btn-mini{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      font-size:13px;
    }
    .btn-mini:disabled{
      opacity:.45;
      cursor:not-allowed;
    }


/* ===== Lottery redesign (like screenshot) ===== */
.lot-screen{padding:0;margin:0;}
.lot-page{padding:14px 14px 18px 14px;}
.lot-top{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:2px;}
.ticket-badge{
  width:84px;height:56px;border-radius:14px;
  background:linear-gradient(180deg,#ff6b7c,#ff8a9a);
  position:relative;display:flex;align-items:center;justify-content:center;
  box-shadow:0 10px 24px rgba(255,107,124,.20);
}
.ticket-badge:before,.ticket-badge:after{
  content:"";position:absolute;top:50%;transform:translateY(-50%);
  width:14px;height:14px;border-radius:50%;
  background:#0f1823;
  opacity:.85;
}
.ticket-badge:before{left:-7px;}
.ticket-badge:after{right:-7px;}
.ticket-text{font-weight:900;letter-spacing:.5px;line-height:1;color:#2b0b10;text-align:center;}
.ticket-text .t1{font-size:12px;}
.ticket-text .t2{font-size:14px;margin-top:2px;}
.lot-h1{font-size:28px;font-weight:900;margin-top:4px;}
.lot-sub{opacity:.9;text-align:center;max-width:320px;line-height:1.35;font-weight:700;}
.lot-history-link{
  display:flex;align-items:center;gap:8px;
  background:transparent;border:0;color:#57a9ff;
  font-weight:900;font-size:15px;cursor:pointer;
}
.lot-history-chev{opacity:.8;margin-left:2px;}
.lot-seg{
  width:100%;max-width:340px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.07);
  border-radius:16px;
  display:flex;
  padding:4px;
  margin-top:6px;
}
.lot-seg-btn{
  flex:1;border:0;background:transparent;color:#cfe5ff;
  padding:10px 10px;border-radius:12px;font-weight:900;cursor:pointer;
}
.lot-seg-btn.active{
  background:rgba(0,0,0,.22);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);
  color:#ffffff;
}
.lot-day-pill{
  margin-top:4px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.07);
  border-radius:999px;
  padding:8px 12px;
  font-weight:900;
  font-size:12px;
  opacity:.95;
}
.lot-view{width:100%;margin-top:14px;}
.lot-card{
  border-radius:18px;
  padding:14px;
  position:relative;
  overflow:hidden;
  margin-top:12px;
  background:
    radial-gradient(circle at 18% 24%, rgba(255,255,255,.18) 0 2px, transparent 3px),
    radial-gradient(circle at 32% 42%, rgba(255,255,255,.12) 0 2px, transparent 3px),
    radial-gradient(circle at 52% 18%, rgba(255,255,255,.14) 0 2px, transparent 3px),
    radial-gradient(circle at 70% 60%, rgba(255,255,255,.10) 0 2px, transparent 3px),
    linear-gradient(180deg, rgba(255,132,93,.95), rgba(214,116,86,.95));
  box-shadow:0 12px 26px rgba(0,0,0,.30);
}
.lot-card-10{
  background:
    radial-gradient(circle at 18% 24%, rgba(255,255,255,.16) 0 2px, transparent 3px),
    radial-gradient(circle at 52% 18%, rgba(255,255,255,.12) 0 2px, transparent 3px),
    radial-gradient(circle at 70% 60%, rgba(255,255,255,.10) 0 2px, transparent 3px),
    linear-gradient(180deg, rgba(255,132,93,.82), rgba(214,116,86,.82));
}
.lot-card-main{padding-right:88px;}
.lot-card-title{font-weight:900;font-size:16px;}
.lot-card-sub{margin-top:6px;opacity:.92;font-weight:800;}
.lot-card-art{
  position:absolute;right:14px;top:18px;
  width:72px;height:72px;border-radius:18px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.12);
  font-size:34px;
}
.lot-card-btn{
  margin-top:10px;
  border:0;
  padding:10px 12px;
  border-radius:999px;
  background:rgba(0,0,0,.18);
  color:#fff;
  font-weight:900;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.lot-card-btn:active{transform:scale(.99);}
.lot-card-footer{
  margin-top:12px;
  padding-top:10px;
  border-top:1px solid rgba(255,255,255,.18);
  font-size:12px;
  opacity:.95;
  font-weight:800;
}
.lot-muted{opacity:.85;}
.lot-dot{opacity:.75;margin:0 6px;}
.lot-mine{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.07);
  border-radius:18px;
  padding:14px;
}
.lot-mine-title{font-weight:900;font-size:15px;margin-bottom:10px;}
.lot-metric .lab{opacity:.8;font-size:12px;font-weight:900;}
.lot-metric .val{margin-top:4px;font-weight:900;font-size:18px;}
.lot-metric .hint{margin-top:2px;opacity:.85;font-size:12px;font-weight:800;}
.lot-buy{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.lot-mini{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.20);
  color:#fff;
  border-radius:12px;
  padding:10px 12px;
  font-weight:900;
  cursor:pointer;
}
.lot-input{
  width:110px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  color:#fff;
  padding:10px 12px;
  font-weight:900;
}
.lot-hint{
  margin-top:10px;
  opacity:.85;
  font-size:12px;
  font-weight:800;
  line-height:1.35;
}
.lot-last{margin-top:12px;}
.lot-last-title{opacity:.8;font-size:12px;font-weight:900;}
.lot-last-body{margin-top:6px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px 12px;font-weight:800;font-size:12px;line-height:1.35;}
.lot-history{margin-top:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.07);border-radius:18px;padding:14px;}
.lot-history-title{font-weight:900;margin-bottom:8px;}
.lot-history-body{opacity:.9;font-weight:800;font-size:12px;line-height:1.45;}
.lot-error{margin-top:12px;color:#ff8a9a;font-weight:900;}
</style>
</head>
<body>
<div class="app">
<div class="header">
<div>archicasino</div>
<div style="display:flex; gap:8px; align-items:center;">
<div id="balanceBadge" style="font-weight:800;font-size:13px;background:#162235;padding:6px 10px;border-radius:999px;">‚≠ê ‚Ä¶</div>
<div id="topupBtn" style="font-weight:900;font-size:13px;background:#5b8ecb;padding:6px 10px;border-radius:999px;cursor:pointer;user-select:none;-webkit-user-select:none;">
          ‚ûï
        </div>
</div>
</div>
<div id="screenRoulette">
<div class="recent-wins" id="recentWins" style="display:none;">
<div class="recent-wins__title">–ù–µ–¥–∞–≤–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–∏</div>
<div class="recent-wins__list" id="recentWinsList"></div>
</div>
<div class="cases-grid" id="casesTabs"></div>
<div class="case-hint" id="caseHint"></div>
<div class="roulette-wrap">
<div class="roulette" data-initialized="false" id="roulette">
<div class="item" data-id="1"><img src="https://emojiapi.dev/api/v1/heart_with_ribbon/128.png"/><div class="price">‚≠ê 15</div></div>
<div class="item" data-id="2"><img src="https://emojiapi.dev/api/v1/teddy_bear/128.png"/><div class="price">‚≠ê 25</div></div>
<div class="item" data-id="4"><img src="https://emojiapi.dev/api/v1/gem_stone/128.png"/><div class="price">‚≠ê 100</div></div>
<div class="item" data-id="3"><img src="https://emojiapi.dev/api/v1/birthday_cake/128.png"/><div class="price">‚≠ê 50</div></div>
<div class="item" data-id="5"><img src="https://emojiapi.dev/api/v1/rose/128.png"/><div class="price">‚≠ê 25</div></div>
</div>
<div class="pointer"></div>
</div>
<div class="switch">–î–µ–º–æ —Ä–µ–∂–∏–º <input type="checkbox"/></div>
<button class="spin" id="spinBtn">–ú–Ω–µ –ø–æ–≤–µ–∑—ë—Ç! üé∞</button>
</div>
<div id="screenInventory" style="display:none;">
<div class="inv">
<div class="inv-title">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
<div id="inventoryEmpty" class="inv-empty-card" style="margin:0;">
  <div class="inv-empty-ico" aria-hidden="true">
    <svg viewBox="0 0 140 100" width="110" height="80" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="f1" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0" stop-color="#f4f7fb"/>
          <stop offset="1" stop-color="#b8c4d2"/>
        </linearGradient>
        <linearGradient id="f2" x1="0" x2="1" y1="0" y2="0">
          <stop offset="0" stop-color="#8ea0b3"/>
          <stop offset="1" stop-color="#cfd9e4"/>
        </linearGradient>
        <filter id="sh" x="-20%" y="-20%" width="140%" height="160%">
          <feDropShadow dx="0" dy="6" stdDeviation="4" flood-color="#000" flood-opacity=".35"/>
        </filter>
      </defs>

      <!-- back panel -->
      <path d="M22 30h96c6 0 10 4 10 10v40c0 6-4 10-10 10H22c-6 0-10-4-10-10V40c0-6 4-10 10-10z"
            fill="url(#f2)" opacity=".35"/>

      <!-- folder -->
      <g filter="url(#sh)">
        <path d="M26 34h34l8-10h46c7 0 12 5 12 12v44c0 7-5 12-12 12H26c-7 0-12-5-12-12V46c0-7 5-12 12-12z"
              fill="#d4dde8"/>
        <path d="M14 48h112v30c0 7-5 12-12 12H26c-7 0-12-5-12-12V48z"
              fill="url(#f1)"/>
        <path d="M26 34h34l8-10h46c7 0 12 5 12 12v44c0 7-5 12-12 12H26c-7 0-12-5-12-12V46c0-7 5-12 12-12z"
              fill="none" stroke="#aab6c5" stroke-width="2" opacity=".9"/>
      </g>
    </svg>
  </div>
  <div class="inv-empty-text">–ù–µ—Ç –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤</div>
</div>
<div class="inv-list" id="inventoryList" style="display:none;"></div>
</div>
</div>
<div id="screenTop" style="display:none;">
<div class="inv">
<div class="inv-title">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
<div class="section" id="topMe" style="margin:0 0 10px 0;">‚Äî</div>
<div class="inv-list" id="topList" style="grid-template-columns: 1fr;"></div>
</div>
</div>
<div class="lot-screen" id="screenLottery" style="display:none;">
<div class="lot-page">
<div class="lot-top">
<div class="ticket-badge">
<div class="ticket-text">
<div class="t1">ADMIT</div>
<div class="t2">ONE</div>
</div>
</div>
<div class="lot-h1">–õ–æ—Ç–µ—Ä–µ–∏</div>
<div class="lot-sub">–£—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ –ª–æ—Ç–µ—Ä–µ—è—Ö –∏ –≤—ã–∏–≥—Ä—ã–≤–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</div>
<button class="lot-history-link" id="lotteryHistoryOpen" type="button">
<span class="lot-history-ico">üïò</span>
<span>–ò—Å—Ç–æ—Ä–∏—è –ª–æ—Ç–µ—Ä–µ–π</span>
<span class="lot-history-chev">‚Ä∫</span>
</button>
<div class="lot-day-pill" id="lotteryDayPill">–í —ç—Ç–æ—Ç –¥–µ–Ω—å ‚Äî ‚Ä¶ üí°</div>
</div>
<div class="lot-view" id="lotViewActive">
<!-- Hourly lottery card -->
<div class="lot-card lot-card-hour">
<div class="lot-card-main">
<div class="lot-card-title">–õ–æ—Ç–µ—Ä–µ—è (–∫–∞–∂–¥—ã–π —á–∞—Å)</div>
<div class="lot-card-sub" id="lotteryCountdown">‚Äî</div>
<button class="lot-card-btn" id="lotteryJoinBtn" type="button">
          –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –∑–∞ <span id="lotteryTicketPriceInline">‚Äî</span> ‚≠ê
        </button>
</div>
<div class="lot-card-art">üéÅ</div>
<div class="lot-card-footer">
<span class="lot-muted">–ü–æ—Ç:</span> <span id="lotteryPot">‚Äî</span>
</div>
</div>
<!-- 10-min lottery card -->
<div class="lot-card lot-card-10">
<div class="lot-card-main">
<div class="lot-card-title">–õ–æ—Ç–µ—Ä–µ—è (–∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç)</div>
<div class="lot-card-sub" id="lottery10Countdown">‚Äî</div>
<button class="lot-card-btn" id="lottery10JoinBtn" type="button">
          –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –∑–∞ <span id="lottery10TicketPriceInline">‚Äî</span> ‚≠ê
        </button>
</div>
<div class="lot-card-art">‚è±Ô∏è</div>
<div class="lot-card-footer">
<span class="lot-muted">–ü–æ—Ç:</span> <span id="lottery10Pot">‚Äî</span>
</div>
</div>
</div>
<div class="lot-history" id="lotteryHistoryPanel" style="display:none;">
<div class="lot-history-title">–ò—Å—Ç–æ—Ä–∏—è –ª–æ—Ç–µ—Ä–µ–π</div>
<div class="lot-history-body" id="lotteryHistoryBody">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
</div>
<div class="lot-error" id="lotteryErr" style="display:none;"></div>
</div>
</div>
</div>
<div class="bottom-nav">
<div class="nav active" id="tabSpin"><div class="nav-icon">üé∞</div><div class="nav-label">–†—É–ª–µ—Ç–∫–∞</div></div>
<div class="nav" id="tabLottery"><div class="nav-icon">üéüÔ∏è</div><div class="nav-label">–õ–æ—Ç–µ—Ä–µ—è</div></div>
<div class="nav" id="tabInv"><div class="nav-icon">üéí</div><div class="nav-label">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div></div>
<div class="nav" id="tabTop"><div class="nav-icon">üèÜ</div><div class="nav-label">–¢–æ–ø</div></div>
</div>
<!-- Claim UI -->
<div id="claimBackdrop"></div>
<div id="claimSheet">
<div class="claim-head">
<div class="claim-title">üéâ –í–∞—à –ø—Ä–∏–∑</div>
<div class="claim-close" id="claimClose">‚úï</div>
</div>
<div class="claim-row">
<img alt="prize" id="claimImg" src=""/>
<div style="display:flex; flex-direction:column; gap:4px;">
<div class="claim-name" id="claimName">‚Äî</div>
<div class="claim-meta" id="claimMeta">‚Äî</div>
</div>
</div>
<div class="claim-actions">
<button class="btn btn-sell" id="btnSell">–ü—Ä–æ–¥–∞—Ç—å</button>
<button class="btn btn-keep" id="btnKeep">–ó–∞–±—Ä–∞—Ç—å</button>
</div>
<div class="claim-hint">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: –ø—Ä–æ–¥–∞—Ç—å –∑–∞ ‚≠ê –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.</div>
</div>
<!-- Topup UI -->
<div id="topupBackdrop"></div>
<div id="topupSheet">
<div class="claim-head" style="margin-bottom:6px;">
<div class="topup-title">‚≠ê –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
<div class="claim-close" id="topupClose">‚úï</div>
</div>
<div class="topup-grid">
<div class="topup-pack" data-stars="50">50 ‚≠ê<small>–±—ã—Å—Ç—Ä–æ</small></div>
<div class="topup-pack" data-stars="100">100 ‚≠ê<small>–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ</small></div>
<div class="topup-pack" data-stars="250">250 ‚≠ê<small>–≤—ã–≥–æ–¥–Ω–æ</small></div>
</div>
<div class="topup-footer">
<button class="btn topup-cancel" id="topupCancel">–û—Ç–º–µ–Ω–∞</button>
<button class="btn topup-buy" disabled="" id="topupBuy">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
</div>
<div class="topup-note">–û–ø–ª–∞—Ç–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ Telegram. –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞.</div>
</div>
<script>
    const API_BASE = "https://test-u2mr.onrender.com"; // <-- –ø–æ–º–µ–Ω—è–π –Ω–∞ —Å–≤–æ–π –±–µ–∫–µ–Ω–¥ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

    const tg = window.Telegram?.WebApp;
window.addEventListener('unhandledrejection', (ev) => {
  console.warn('Unhandled rejection:', ev?.reason || ev);
});
window.addEventListener('error', (ev) => {
  // keep it quiet, but log for debugging
  console.warn('Global error:', ev?.message || ev);
});
    try { tg?.ready(); } catch (_) {}

    const btn = document.getElementById('spinBtn');
    const roulette = document.getElementById('roulette');
    const balanceBadge = document.getElementById('balanceBadge');

    const topupBtn = document.getElementById('topupBtn');
    const topupBackdrop = document.getElementById('topupBackdrop');
    const topupSheet = document.getElementById('topupSheet');
    const topupClose = document.getElementById('topupClose');
    const topupCancel = document.getElementById('topupCancel');
    const topupBuy = document.getElementById('topupBuy');
    const topupPacks = Array.from(document.querySelectorAll('.topup-pack[data-stars]'));
    let selectedTopupStars = null;
    let topupInFlight = false;

    const screenRoulette = document.getElementById('screenRoulette');
    const screenInventory = document.getElementById('screenInventory');
    const screenTop = document.getElementById('screenTop');
    const screenLottery = document.getElementById('screenLottery');

    const tabSpin = document.getElementById('tabSpin');
    const tabInv = document.getElementById('tabInv');
    const tabTop = document.getElementById('tabTop');
    const tabLottery = document.getElementById('tabLottery');

    // Lottery DOM refs (avoid relying on "id as global" browser behavior)
    const lotteryCountdown = document.getElementById('lotteryCountdown');
    const lotteryPot = document.getElementById('lotteryPot');
    const lotteryPrize = document.getElementById('lotteryPrize');
    const lotteryMy = document.getElementById('lotteryMy');
    const lotteryTicketPriceEl = document.getElementById('lotteryTicketPrice');
    const lotteryBuy1 = document.getElementById('lotteryBuy1');
    const lotteryBuy5 = document.getElementById('lotteryBuy5');
    const lotteryQty = document.getElementById('lotteryQty');
    const lotteryBuyQty = document.getElementById('lotteryBuyQty');
    const lotteryBuyHint = document.getElementById('lotteryBuyHint');
    const lotteryLast = document.getElementById('lotteryLast');

    // Lottery10 DOM refs
    const lottery10Countdown = document.getElementById('lottery10Countdown');
    const lottery10Pot = document.getElementById('lottery10Pot');
    const lottery10Prize = document.getElementById('lottery10Prize');
    const lottery10My = document.getElementById('lottery10My');
    const lottery10TicketPriceEl = document.getElementById('lottery10TicketPrice');
    const lottery10Buy1 = document.getElementById('lottery10Buy1');
    const lottery10Buy10 = document.getElementById('lottery10Buy10');
    const lottery10Qty = document.getElementById('lottery10Qty');
    const lottery10BuyQty = document.getElementById('lottery10BuyQty');
    const lottery10BuyHint = document.getElementById('lottery10BuyHint');
    const lottery10Last = document.getElementById('lottery10Last');

    // Lottery UI (segmented + quick-join + history)
    const lotSegActive = document.getElementById('lotSegActive');
    const lotSegMine = document.getElementById('lotSegMine');
    const lotViewActive = document.getElementById('lotViewActive');
    const lotViewMine = document.getElementById('lotViewMine');
    const lotteryJoinBtn = document.getElementById('lotteryJoinBtn');
    const lottery10JoinBtn = document.getElementById('lottery10JoinBtn');
    const lotteryHistoryOpen = document.getElementById('lotteryHistoryOpen');
    const lotteryHistoryPanel = document.getElementById('lotteryHistoryPanel');
    const lotteryHistoryBody = document.getElementById('lotteryHistoryBody');
    const lotteryDayPill = document.getElementById('lotteryDayPill');
    // Date pill like "–í —ç—Ç–æ—Ç –¥–µ–Ω—å ‚Äî 21 –¥–µ–∫–∞–±—Ä—è"
    if (lotteryDayPill) {
      const dt = new Date();
      const m = dt.toLocaleString('ru-RU', { month: 'long' });
      lotteryDayPill.textContent = `–í —ç—Ç–æ—Ç –¥–µ–Ω—å ‚Äî ${dt.getDate()} ${m} üí°`;
    }

    if (lotteryJoinBtn) lotteryJoinBtn.addEventListener('click', () => buyLotteryTickets(1));
    if (lottery10JoinBtn) lottery10JoinBtn.addEventListener('click', () => buyLottery10Tickets(1));

    if (lotteryHistoryOpen) lotteryHistoryOpen.addEventListener('click', async () => {
      if (!lotteryHistoryPanel || !lotteryHistoryBody) return;
      const shown = lotteryHistoryPanel.style.display !== 'none';
      lotteryHistoryPanel.style.display = shown ? 'none' : 'block';
      if (shown) return;

      // try load history for both lotteries (ignore if endpoint absent)
      lotteryHistoryBody.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';
      let parts = [];
      try {
        const h1 = await apiPost('/lottery/history', { initData: tg?.initData || '' });
        if (h1?.items?.length) {
          const lines = h1.items.slice(0, 10).map(x => {
            const dt = new Date((Number(x.hour_start || 0) || 0) * 1000);
            const when = dt.toLocaleString();
            const w = x.winner_name || (x.winner_user_id ? ('User ' + String(x.winner_user_id).slice(-4)) : '‚Äî');
            return `‚Ä¢ ${when} ‚Äî ${w} ‚Äî ‚≠ê ${x.prize_amount || 0}`;
          });
          parts.push('–ß–∞—Å–æ–≤–∞—è:\n' + lines.join('\n'));
        }
      } catch (e) {}

      try {
        const h2 = await apiPost('/lottery10/history', { initData: tg?.initData || '' });
        if (h2?.items?.length) {
          const lines = h2.items.slice(0, 10).map(x => {
            const dt = new Date((Number(x.period_start || 0) || 0) * 1000);
            const when = dt.toLocaleString();
            const w = x.winner_name || (x.winner_user_id ? ('User ' + String(x.winner_user_id).slice(-4)) : '‚Äî');
            return `‚Ä¢ ${when} ‚Äî ${w} ‚Äî ‚≠ê ${x.prize_amount || 0}`;
          });
          parts.push('–ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç:\n' + lines.join('\n'));
        }
      } catch (e) {}

      lotteryHistoryBody.textContent = parts.length ? parts.join('\n\n') : '–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
    });


    // Lottery globals (must be defined in global scope)
    let lotteryRefreshInterval = null;
    let lotteryCountdownInterval = null;
    let lotteryEndsAt = null;
    let lotteryTicketPrice = null;
    let lottery10EndsAt = null;
    let lottery10TicketPrice = null;


    const inventoryList = document.getElementById('inventoryList');
    const inventoryEmpty = document.getElementById('inventoryEmpty');

    const topList = document.getElementById('topList');
    const topMe = document.getElementById('topMe');

    const claimBackdrop = document.getElementById('claimBackdrop');
    const claimSheet = document.getElementById('claimSheet');
    const claimClose = document.getElementById('claimClose');
    const claimImg = document.getElementById('claimImg');
    const claimName = document.getElementById('claimName');
    const claimMeta = document.getElementById('claimMeta');
    const btnSell = document.getElementById('btnSell');
    const btnKeep = document.getElementById('btnKeep');

    const casesTabs = document.getElementById('casesTabs');
    const caseHint = document.getElementById('caseHint');
    let selectedCaseId = null;
    let selectedCase = null;

	    // Pending (open claim from previous spin)
	    // These vars are referenced by the Spin button handler and by openClaim().
	    let pendingSpinId = null;
	    let pendingPrize = null;

    function renderCases(items){
      if (!casesTabs) return;
      casesTabs.innerHTML = '';
      (items || []).forEach((c, idx) => {
        const el = document.createElement('div');
        const isActive = ((selectedCaseId && c.id === selectedCaseId) || (!selectedCaseId && idx === 0));
        el.className = 'case-card' + (isActive ? ' active' : '');
        el.dataset.caseId = String(c.id);

        const img = document.createElement('img');
        img.className = 'case-cover';
        img.alt = c?.name || 'case';
        img.referrerPolicy = 'no-referrer';
        img.loading = 'lazy';
        img.src = (c?.cover_url || '').trim() || 'https://emojiapi.dev/api/v1/wrapped_gift/128.png';

        const name = document.createElement('div');
        name.className = 'case-name';
        name.textContent = c?.name || '–ö–µ–π—Å';

        const price = document.createElement('div');
        price.className = 'case-price';
        price.textContent = `‚≠ê ${c?.price ?? ''}`;

        el.appendChild(img);
        el.appendChild(name);
        el.appendChild(price);

        el.addEventListener('click', async () => {
          Array.from(casesTabs.querySelectorAll('.case-card')).forEach(x => x.classList.remove('active'));
          el.classList.add('active');
          selectedCaseId = c.id;
          selectedCase = c;
          try { tg?.HapticFeedback?.selectionChanged(); } catch (_) {}
          await refreshCasePrizes();
        });

        casesTabs.appendChild(el);
      });
    }

    async function refreshCases(){
      try{
        const res = await apiPost('/cases', { initData: tg?.initData || '' });
        const items = Array.isArray(res?.items) ? res.items : [];
        if (items.length){
          if (!selectedCaseId) {
            selectedCaseId = items[0].id;
            selectedCase = items[0];
          } else {
            selectedCase = items.find(x => x.id === selectedCaseId) || items[0];
            selectedCaseId = selectedCase.id;
          }
        }
        renderCases(items);
        await refreshCasePrizes();
      }catch(e){
        console.warn('refreshCases failed', e);
      }
    }

    async function refreshCasePrizes(){
      if (!selectedCaseId) return;
      try{
        const res = await apiPost(`/cases/${selectedCaseId}/prizes`, { initData: tg?.initData || '' });
        const items = Array.isArray(res?.items) ? res.items : [];
        setPrizes(items);
        rebuildRouletteFromPrizes(items);
        const caseInfo = res?.case || selectedCase;
        if (caseHint){
          const desc = (caseInfo && caseInfo.description) ? String(caseInfo.description) : '';
          caseHint.textContent = '';
        }
        // update button label
        if (btn && caseInfo && typeof caseInfo.price === 'number'){
          btn.textContent = `–ö—Ä—É—Ç–∏—Ç—å ‚Ä¢ ${caseInfo.price} ‚≠ê`;
        }
      }catch(e){
        console.warn('refreshCasePrizes failed', e);
      }
    }

    async function apiPost(path, payload) {
  const url = `${API_BASE}${path}`;
  let res;
  try {
    res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload ?? {})
    });
  } catch (e) {
    // Network error (DNS/CORS/mixed content/offline)
    throw new Error(`NETWORK: ${e?.message || e} ‚Ä¢ ${url}`);
  }

  const text = await res.text();

  if (!res.ok) {
    throw new Error(`HTTP ${res.status}: ${text || '(empty)'} ‚Ä¢ ${url}`);
  }

  if (!text) return null;

  try {
    return JSON.parse(text);
  } catch (e) {
    // Often happens when API_BASE is wrong and we hit HTML, or backend returns non-JSON.
    const snippet = text.slice(0, 220).replace(/\s+/g, ' ').trim();
    throw new Error(`BAD_JSON: ${e?.message || e} ‚Ä¢ ${url} ‚Ä¢ body="${snippet}"`);
  }
}
    // ===== Prizes (icons from backend) =====
    let PRIZES_BY_ID = {};

    function setPrizes(items) {
      PRIZES_BY_ID = {};
      const list = Array.isArray(items) ? items : [];
      for (const p of list) {
        if (!p || !p.id) continue;
        PRIZES_BY_ID[Number(p.id)] = p;
      }
    }

    function rebuildRouletteFromPrizes(items) {
  if (!r) return;
  const list = Array.isArray(items) ? items : [];
  if (!list.length) {
    r.innerHTML = '';
    r.dataset.initialized = 'false';
    return;
  }

  // Reset infinite-scroll clone state
  r.dataset.initialized = 'false';
  r.innerHTML = '';

  // CS2-like visual tape: common items appear more often, rare items less often.
  const weights = list.map(p => Math.max(1, Number(p?.weight ?? 1)));
  const totalW = weights.reduce((a, b) => a + b, 0);

  const baseSlots = Math.max(72, Math.min(120, list.length * 24));
  const pool = [];

  // Deterministic proportional replication
  for (let i = 0; i < list.length; i++) {
    const p = list[i];
    const w = weights[i];
    let reps = Math.max(1, Math.round((w / totalW) * baseSlots));
    for (let k = 0; k < reps; k++) pool.push(p);
  }

  // If rounding produced too few/too many slots, normalize to baseSlots
  const pickWeighted = () => {
    let x = Math.random() * totalW;
    for (let i = 0; i < list.length; i++) {
      x -= weights[i];
      if (x <= 0) return list[i];
    }
    return list[list.length - 1];
  };

  while (pool.length < baseSlots) pool.push(pickWeighted());
  while (pool.length > baseSlots) pool.pop();

  // Shuffle (Fisher‚ÄìYates)
  for (let i = pool.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }

  // Avoid long runs of the same prize id (visual nicety)
  for (let i = 2; i < pool.length; i++) {
    const a = pool[i - 2]?.id;
    const b = pool[i - 1]?.id;
    const c = pool[i]?.id;
    if (a && b && c && a === b && b === c) {
      // find a different one later and swap
      for (let j = i + 1; j < Math.min(pool.length, i + 12); j++) {
        if (pool[j]?.id !== c) { [pool[i], pool[j]] = [pool[j], pool[i]]; break; }
      }
    }
  }

  for (const p of pool) {
    const item = document.createElement('div');
    item.className = 'item';
    item.dataset.id = String(p.id);

    const img = document.createElement('img');
    img.src = (p.icon_url || '').trim() || giftImageById(p.id);
    img.alt = 'prize';
    img.referrerPolicy = 'no-referrer';

    const price = document.createElement('div');
    price.className = 'price';
    price.textContent = `‚≠ê ${p.cost ?? ''}`;

    item.appendChild(img);
    item.appendChild(price);
    r.appendChild(item);
  }

  // Make sure the infinite tape is ready after rebuilding (case switch)
  try { requestAnimationFrame(() => initInfiniteRoulette()); } catch (_) {}
}

async function refreshPrizes() {
      // kept for backward compatibility
      return await refreshCases();
    }

    async function refreshBalance() {
      try {
        const me = await apiPost('/me', { initData: tg?.initData || '' });
        if (balanceBadge) balanceBadge.textContent = `‚≠ê ${me.balance}`;
      } catch (_) {
        if (balanceBadge) balanceBadge.textContent = '‚≠ê ‚Äî';
      }
    }

    // ===== Recent wins =====
    const recentWinsWrap = document.getElementById('recentWins');
    const recentWinsList = document.getElementById('recentWinsList');

    function initialsFromName(name) {
      const s = (name || '').trim().replace(/^@/, '');
      if (!s) return 'U';
      const parts = s.split(/\s+/).filter(Boolean);
      const a = (parts[0] || '')[0] || 'U';
      const b = (parts[1] || '')[0] || '';
      return (a + b).toUpperCase();
    }

    function renderRecentWins(items) {
      if (!recentWinsWrap || !recentWinsList) return;

      const list = Array.isArray(items) ? items : [];
      if (!list.length) {
        recentWinsWrap.style.display = 'none';
        recentWinsList.innerHTML = '';
        return;
      }

      recentWinsWrap.style.display = '';
      recentWinsList.innerHTML = '';

      for (const it of list) {
        const el = document.createElement('div');
        el.className = 'recent-win';

        let avatarNode;
        if (it && it.avatar) {
          const img = document.createElement('img');
          img.className = 'recent-win__avatar';
          img.src = it.avatar;
          img.alt = it.name || 'user';
          img.referrerPolicy = 'no-referrer';
          avatarNode = img;
        } else {
          const ph = document.createElement('div');
          ph.className = 'recent-win__avatar recent-win__avatar--ph';
          ph.textContent = initialsFromName(it?.name);
          avatarNode = ph;
        }

        const meta = document.createElement('div');
        meta.className = 'recent-win__meta';

        const name = document.createElement('div');
        name.className = 'recent-win__name';
        name.textContent = it?.name || 'User';

        const prizeText = (it?.prize || it?.prize_name || '').trim();
        const prizeRow = document.createElement('div');
        prizeRow.className = 'recent-win__prize';
        if (it?.icon_url) {
          const pi = document.createElement('img');
          pi.className = 'recent-win__prize-icon';
          pi.src = String(it.icon_url).trim();
          pi.alt = 'icon';
          pi.referrerPolicy = 'no-referrer';
          prizeRow.appendChild(pi);
        }
        const pt = document.createElement('span');
        pt.textContent = prizeText;
        prizeRow.appendChild(pt);

        meta.appendChild(name);
        if (prizeText) meta.appendChild(prizeRow);

        el.appendChild(avatarNode);
        el.appendChild(meta);
        recentWinsList.appendChild(el);
      }
    }

    async function refreshRecentWins() {
      try {
        const res = await apiPost('/recent_wins', { initData: tg?.initData || '' });
        renderRecentWins(res?.items || []);
      } catch (_) {
        // silently ignore
      }
    }

    function giftImageById(id) {
      const p = PRIZES_BY_ID && PRIZES_BY_ID[Number(id)];
      const url = (p && p.icon_url) ? String(p.icon_url).trim() : '';
      if (url) return url;

      const map = {
        1: 'https://emojiapi.dev/api/v1/heart_with_ribbon/128.png',
        2: 'https://emojiapi.dev/api/v1/teddy_bear/128.png',
        3: 'https://emojiapi.dev/api/v1/birthday_cake/128.png',
        4: 'https://emojiapi.dev/api/v1/gem_stone/128.png',
        5: 'https://emojiapi.dev/api/v1/rose/128.png'
      };
      return map[id] || map[1];
    }

    async function refreshInventory() {
      if (!inventoryList || !inventoryEmpty) return;
      try {
        const inv = await apiPost('/inventory', { initData: tg?.initData || '' });
        const items = Array.isArray(inv.items) ? inv.items : [];

        if (!items.length) {
          inventoryEmpty.style.display = '';
          inventoryList.style.display = 'none';
          inventoryList.innerHTML = '';
          return;
        }

        inventoryEmpty.style.display = 'none';
        inventoryList.style.display = '';
        inventoryList.innerHTML = items.map(it => {
          const img = (it && it.icon_url) ? String(it.icon_url).trim() : giftImageById(it.prize_id || it.id);
          const name = it.prize_name || it.name || '–ü–æ–¥–∞—Ä–æ–∫';
          const cost = it.prize_cost ?? it.cost ?? '';
          const when = it.created_at ? new Date(it.created_at * 1000).toLocaleString() : '';
          return `
            <div class="inv-card">
              <img src="${img}" alt="gift" />
              <div class="inv-meta">
                <div class="inv-name">${name}</div>
                <div class="inv-sub">‚≠ê ${cost} ${when ? '‚Ä¢ ' + when : ''}</div>
                <div class="inv-actions">
                  <button class="btn-mini" data-act="sell" data-invid="${it.inventory_id || ''}" ${it.is_locked ? 'disabled' : ''}>–ü—Ä–æ–¥–∞—Ç—å</button>
                  <button class="btn-mini" data-act="withdraw" data-invid="${it.inventory_id || ''}" ${it.is_locked ? 'disabled' : ''}>–í—ã–≤–µ—Å—Ç–∏</button>
                </div>
                ${it.is_locked ? `<div class="inv-sub" style="opacity:.7;margin-top:6px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${it.locked_reason || '‚Äî'}</div>` : ``}
              </div>
            </div>
          `;
        }).join('');
      } catch (_) {
        inventoryEmpty.style.display = '';
        inventoryList.style.display = 'none';
        inventoryList.innerHTML = '';
      }
    }

    
    if (inventoryList && !inventoryList.dataset.bound) {
      inventoryList.dataset.bound = '1';
      inventoryList.addEventListener('click', async (e) => {
        const t = e.target;
        const act = t?.dataset?.act;
        const id = parseInt(t?.dataset?.invid || '', 10);
        if (!act || !id) return;
        t.disabled = true;
        try{
          if (act === 'sell'){
            const res = await apiPost('/inventory/sell', { initData: tg?.initData || '', inventory_id: id });
            if (balanceBadge && res && typeof res.balance === 'number') balanceBadge.textContent = `‚≠ê ${res.balance}`;
            await refreshInventory();
          } else if (act === 'withdraw'){
            const res = await apiPost('/inventory/withdraw', { initData: tg?.initData || '', inventory_id: id });
            await refreshInventory();
            if (res?.status === 'sent') {
              alert('–ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.');
            } else if (res?.status === 'claim_created') {
              alert('–ó–∞—è–≤–∫–∞ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ —Å–æ–∑–¥–∞–Ω–∞. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –µ—ë.');
            } else if (res?.status === 'locked') {
              alert('–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ.');
            }
          }
        }catch(err){
          alert(String(err?.message || err));
        }finally{
          t.disabled = false;
        }
      });
    }


function fmtHHMMSS(sec) {
      sec = Math.max(0, Math.floor(sec || 0));
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      const pad = (x) => String(x).padStart(2, '0');
      return (h > 0 ? (pad(h) + ':') : '') + pad(m) + ':' + pad(s);
    }

    function startLotteryTimers() {
      if (lotteryRefreshInterval) return;

      lotteryRefreshInterval = setInterval(() => {
        if (!tabLottery?.classList.contains('active')) return;
        refreshLottery();
        refreshLottery10();
      }, 10000);

      lotteryCountdownInterval = setInterval(() => {
        if (!tabLottery?.classList.contains('active')) return;
        const now = Math.floor(Date.now() / 1000);
        if (lotteryEndsAt) {
          const left = Math.max(0, lotteryEndsAt - now);
          if (lotteryCountdown) lotteryCountdown.textContent = `–î–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞: ${fmtHHMMSS(left)}`;
        }
        if (lottery10EndsAt) {
          const left10 = Math.max(0, lottery10EndsAt - now);
          if (lottery10Countdown) lottery10Countdown.textContent = `–î–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞: ${fmtHHMMSS(left10)}`;
        }
      }, 1000);
    }

    function stopLotteryTimers() {
      if (lotteryRefreshInterval) {
        clearInterval(lotteryRefreshInterval);
        lotteryRefreshInterval = null;
      }
      if (lotteryCountdownInterval) {
        clearInterval(lotteryCountdownInterval);
        lotteryCountdownInterval = null;
      }
    }

    async function refreshLottery() {
      if (!lotteryCountdown) return;
      try {
        const res = await apiPost('/lottery/status', { initData: tg?.initData || '' });
        const lot = res?.lottery || {};

        if (balanceBadge && res?.balance !== undefined) balanceBadge.textContent = `‚≠ê ${res.balance}`;

        lotteryEndsAt = Number(lot.hour_end || 0) || null;
        lotteryTicketPrice = Number(lot.ticket_price || 0) || null;

        const totalSpent = Number(lot.total_spent || 0);
        const totalTickets = Number(lot.total_tickets || 0);
        const prize80 = Math.floor(totalSpent * 0.80);

        if (lotteryPot) lotteryPot.textContent = `‚≠ê ${totalSpent}`;
        if (lotteryPrize) { lotteryPrize.textContent = ''; lotteryPrize.style.display = 'none'; }

        const myTickets = Number(lot.my_tickets || 0);
        const mySpent = Number(lot.my_spent || (myTickets * (lotteryTicketPrice || 0)) || 0);
        if (lotteryMy) lotteryMy.textContent = `${myTickets} —à—Ç. ‚Ä¢ ‚≠ê ${mySpent}`;
        if (lotteryTicketPriceEl) lotteryTicketPriceEl.textContent = `–¶–µ–Ω–∞ –±–∏–ª–µ—Ç–∞: ‚≠ê ${lotteryTicketPrice || '‚Äî'} ‚Ä¢ –í—Å–µ–≥–æ –±–∏–ª–µ—Ç–æ–≤: ${totalTickets}`;

        const lotteryTicketPriceInline = document.getElementById('lotteryTicketPriceInline');
        if (lotteryTicketPriceInline) lotteryTicketPriceInline.textContent = (lotteryTicketPrice ?? '‚Äî');

        const now = Math.floor(Date.now() / 1000);
        const left = Math.max(0, (lotteryEndsAt || 0) - now);
        if (lotteryCountdown) lotteryCountdown.textContent = `–î–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞: ${fmtHHMMSS(left)}`;

        if (lotteryBuyHint) {
          lotteryBuyHint.textContent = `–ö—É–ø–∏ –±–∏–ª–µ—Ç—ã —Å–µ–π—á–∞—Å ‚Äî —Ä–æ–∑—ã–≥—Ä—ã—à –≤ –∫–æ–Ω—Ü–µ —á–∞—Å–∞.`;
        }

        const last = res?.last;
        if (lotteryLast) {
          if (last && last.hour_start) {
            const dt = new Date((Number(last.hour_start) || 0) * 1000);
            const when = dt.toLocaleString();
            const wname = last.winner_name || (last.winner_user_id ? ('User ' + String(last.winner_user_id).slice(-4)) : '‚Äî');
            lotteryLast.textContent = `${when} ‚Ä¢ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${wname} ‚Ä¢ –ü–æ—Ç: ‚≠ê ${last.total_spent || 0}`;
          } else {
            lotteryLast.textContent = '‚Äî';
          }
        }
      } catch (e) {
        lotteryCountdown.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ—Ç–µ—Ä–µ–∏';
        if (lotteryBuyHint) lotteryBuyHint.textContent = (e?.message || e || '').toString();
      }
    }

    async function buyLotteryTickets(qty) {
      qty = Number(qty || 0);
      if (!qty || qty < 1) return;
      try {
        const res = await apiPost('/lottery/buy', { initData: tg?.initData || '', qty });
        if (balanceBadge && res?.balance !== undefined) balanceBadge.textContent = `‚≠ê ${res.balance}`;
        try { tg?.HapticFeedback?.notificationOccurred?.('success'); } catch (_) {}
        refreshLottery();
      } catch (e) {
        try { tg?.HapticFeedback?.notificationOccurred?.('error'); } catch (_) {}
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç: ' + (e?.message || e));
      }
    }

    lotteryBuy1?.addEventListener('click', () => buyLotteryTickets(1));
    lotteryBuy5?.addEventListener('click', () => buyLotteryTickets(5));
    lotteryBuyQty?.addEventListener('click', () => buyLotteryTickets(Number(lotteryQty?.value || 1)));

    async function refreshLottery10() {
      if (!lottery10Countdown) return;
      try {
        const res = await apiPost('/lottery10/status', { initData: tg?.initData || '' });
        const lot = res?.lottery || {};

        if (balanceBadge && res?.balance !== undefined) balanceBadge.textContent = `‚≠ê ${res.balance}`;

        lottery10EndsAt = Number(lot.period_end || 0) || null;
        lottery10TicketPrice = Number(lot.ticket_price || 0) || null;

        const totalSpent = Number(lot.total_spent || 0);
        const totalTickets = Number(lot.total_tickets || 0);
        const prize80 = Math.floor(totalSpent * 0.80);

        if (lottery10Pot) lottery10Pot.textContent = `‚≠ê ${totalSpent}`;
        if (lottery10Prize) { lottery10Prize.textContent = ''; lottery10Prize.style.display = 'none'; }

        const myTickets = Number(lot.my_tickets || 0);
        if (lottery10My) lottery10My.textContent = `${myTickets} —à—Ç.`;
        if (lottery10TicketPriceEl) lottery10TicketPriceEl.textContent = `–¶–µ–Ω–∞ –±–∏–ª–µ—Ç–∞: ‚≠ê ${lottery10TicketPrice || '‚Äî'} ‚Ä¢ –í—Å–µ–≥–æ –±–∏–ª–µ—Ç–æ–≤: ${totalTickets}`;

        const lottery10TicketPriceInline = document.getElementById('lottery10TicketPriceInline');
        if (lottery10TicketPriceInline) lottery10TicketPriceInline.textContent = (lottery10TicketPrice ?? '‚Äî');

        const now = Math.floor(Date.now() / 1000);
        const left = Math.max(0, (lottery10EndsAt || 0) - now);
        if (lottery10Countdown) lottery10Countdown.textContent = `–î–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞: ${fmtHHMMSS(left)}`;

        if (lottery10BuyHint) {
          lottery10BuyHint.textContent = `–ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–π –±–∏–ª–µ—Ç.`;
        }

        const last = res?.last;
        if (lottery10Last) {
          if (last && last.period_start) {
            const dt = new Date((Number(last.period_start) || 0) * 1000);
            const when = dt.toLocaleString();
            const wname = last.winner_name || (last.winner_user_id ? ('User ' + String(last.winner_user_id).slice(-4)) : '‚Äî');
            lottery10Last.textContent = `${when} ‚Ä¢ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${wname} ‚Ä¢ –ü–æ—Ç: ‚≠ê ${last.total_spent || 0}`;
          } else {
            lottery10Last.textContent = '‚Äî';
          }
        }
      } catch (e) {
        lottery10Countdown.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ—Ç–µ—Ä–µ–∏ (10 –º–∏–Ω)';
        if (lottery10BuyHint) lottery10BuyHint.textContent = (e?.message || e || '').toString();
      }
    }

    async function buyLottery10Tickets(qty) {
      qty = Number(qty || 0);
      if (!qty || qty < 1) return;
      try {
        const res = await apiPost('/lottery10/buy', { initData: tg?.initData || '', qty });
        if (balanceBadge && res?.balance !== undefined) balanceBadge.textContent = `‚≠ê ${res.balance}`;
        try { tg?.HapticFeedback?.notificationOccurred?.('success'); } catch (_) {}
        refreshLottery10();
      } catch (e) {
        try { tg?.HapticFeedback?.notificationOccurred?.('error'); } catch (_) {}
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç (10 –º–∏–Ω): ' + (e?.message || e));
      }
    }

    lottery10Buy1?.addEventListener('click', () => buyLottery10Tickets(1));
    lottery10Buy10?.addEventListener('click', () => buyLottery10Tickets(10));
    lottery10BuyQty?.addEventListener('click', () => buyLottery10Tickets(Number(lottery10Qty?.value || 1)));




    async function refreshLeaderboard() {
      if (!topList || !topMe) return;

      topMe.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      topList.innerHTML = '';

      try {
        const res = await apiPost('/leaderboard', { initData: tg?.initData || '', limit: 30 });
        const items = Array.isArray(res.items) ? res.items : [];
        const me = res.me || {};

        const meBalance = (me.balance ?? '‚Äî');
        const meSpins = (me.spins ?? me.spins_count ?? me.total_spins ?? 0);
        const meWon = (me.won_stars ?? me.wonStars ?? me.stars_won ?? me.won ?? 0);

        topMe.textContent = `–í–∞—à–µ –º–µ—Å—Ç–æ: #${me.rank ?? '‚Äî'} ‚Ä¢ –ë–∞–ª–∞–Ω—Å: ‚≠ê ${meBalance} ‚Ä¢ –°–ø–∏–Ω—ã: ${meSpins} ‚Ä¢ –í—ã–∏–≥—Ä–∞–Ω–æ: ‚≠ê ${meWon}`;

        topList.innerHTML = items.map(it => {
          const badge = it.is_me ? ' style="box-shadow: inset 0 0 0 2px rgba(74,163,255,0.55)"' : '';
          const av = it.avatar
            ? `<img class="lb-avatar" src="${it.avatar}" alt="avatar" referrerpolicy="no-referrer" />`
            : `<div class="lb-avatar lb-avatar--ph">${initialsFromName(it.name)}</div>`;

          const spins = (it.spins ?? it.spins_count ?? it.total_spins ?? 0);
          const won = (it.won_stars ?? it.wonStars ?? it.stars_won ?? it.won ?? 0);

          return `
            <div class="inv-card"${badge}>
              ${av}
              <div class="inv-meta" style="width:100%;">
                <div class="inv-name">#${it.rank} ‚Ä¢ ${it.name}</div>
                <div class="inv-sub">–ë–∞–ª–∞–Ω—Å: ‚≠ê ${it.balance} ‚Ä¢ –°–ø–∏–Ω—ã: ${spins} ‚Ä¢ –í—ã–∏–≥—Ä–∞–Ω–æ: ‚≠ê ${won}</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (_) {
        topMe.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞';
        topList.innerHTML = '';
      }
    }

    function setTab(which) {
          const isInv = which === 'inv';
          const isTop = which === 'top';
          const isLottery = which === 'lottery';
    
          if (screenRoulette) screenRoulette.style.display = (isInv || isTop || isLottery) ? 'none' : '';
          if (screenInventory) screenInventory.style.display = isInv ? '' : 'none';
          if (screenTop) screenTop.style.display = isTop ? '' : 'none';
          if (screenLottery) screenLottery.style.display = isLottery ? '' : 'none';
    
          tabSpin?.classList.toggle('active', which === 'spin');
          tabInv?.classList.toggle('active', isInv);
          tabTop?.classList.toggle('active', isTop);
          tabLottery?.classList.toggle('active', isLottery);
    
          if (isInv) refreshInventory();
          if (isTop) refreshLeaderboard();
          if (isLottery) {
            refreshLottery();
            refreshLottery10();
            startLotteryTimers();
          } else {
            stopLotteryTimers();
          }
        }
    
        tabSpin?.addEventListener('click', () => setTab('spin'));
        tabLottery?.addEventListener('click', () => setTab('lottery'));
        tabInv?.addEventListener('click', () => setTab('inv'));
        tabTop?.addEventListener('click', () => setTab('top'));
    

        // ===== Topup =====
    function openTopup() {
      selectedTopupStars = null;
      topupPacks.forEach(p => p.style.boxShadow = '');
      if (topupBuy) topupBuy.disabled = true;

      topupBackdrop.style.display = 'block';
      topupSheet.style.display = 'block';
      try { tg?.HapticFeedback?.selectionChanged(); } catch (_) {}
    }

    function closeTopup() {
      if (topupInFlight) return;
      topupBackdrop.style.display = 'none';
      topupSheet.style.display = 'none';
    }

    function openInvoiceSmart(link) {
      try {
        if (tg?.openInvoice) {
          tg.openInvoice(link, (status) => {
            if (status === 'paid' || status === 'pending') {
              setTimeout(refreshBalance, 800);
              setTimeout(refreshBalance, 2000);
              setTimeout(refreshBalance, 5000);
            }
          });
          return;
        }
      } catch (_) {}

      try {
        if (tg?.openTelegramLink && /^https?:\/\/t\.me\//i.test(link)) {
          tg.openTelegramLink(link);
          return;
        }
        if (tg?.openLink) {
          tg.openLink(link);
          return;
        }
      } catch (_) {}

      window.open(link, "_blank");
    }

    async function doTopup(stars) {
      if (topupInFlight) return;
      topupInFlight = true;
      if (topupBuy) topupBuy.disabled = true;

      try {
        const res = await apiPost('/topup/create', { initData: tg?.initData || '', stars });
        const link = res?.invoice_link;
        if (!link) throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª invoice_link. –ü—Ä–æ–≤–µ—Ä—å BOT_TOKEN –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.');

        openInvoiceSmart(link);
        closeTopup();
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ' + (e?.message || e));
      } finally {
        topupInFlight = false;
        if (topupBuy) topupBuy.disabled = !(selectedTopupStars > 0);
      }
    }

    topupBtn?.addEventListener('click', openTopup);
    topupBtn?.addEventListener('touchend', (e) => { e.preventDefault(); openTopup(); }, { passive: false });

    topupClose?.addEventListener('click', closeTopup);
    topupClose?.addEventListener('touchend', (e) => { e.preventDefault(); closeTopup(); }, { passive: false });

    topupCancel?.addEventListener('click', closeTopup);
    topupCancel?.addEventListener('touchend', (e) => { e.preventDefault(); closeTopup(); }, { passive: false });

    topupBackdrop.onclick = (e) => { try { e.preventDefault(); } catch (_) {} closeTopup(); };

    topupPacks.forEach(p => {
      const pick = () => {
        if (topupInFlight) return;
        topupPacks.forEach(x => x.style.boxShadow = '');
        p.style.boxShadow = 'inset 0 0 0 2px rgba(74,163,255,0.55)';
        selectedTopupStars = parseInt(p.dataset.stars, 10) || null;
        if (topupBuy) topupBuy.disabled = !(selectedTopupStars > 0);
        try { tg?.HapticFeedback?.selectionChanged(); } catch (_) {}
      };
      p.addEventListener('click', pick);
      p.addEventListener('touchend', (e) => { e.preventDefault(); pick(); }, { passive: false });
    });

    topupBuy?.addEventListener('click', () => selectedTopupStars && doTopup(selectedTopupStars));
    topupBuy?.addEventListener('touchend', (e) => { e.preventDefault(); selectedTopupStars && doTopup(selectedTopupStars); }, { passive: false });

    // ===== Claim (prize) =====
    function openClaim(prize) {
      pendingPrize = prize;
      pendingSpinId = prize.spin_id || prize.spinId || prize.spinID || null;

      if (!pendingSpinId) {
        alert('–û—à–∏–±–∫–∞: /spin –Ω–µ –≤–µ—Ä–Ω—É–ª spin_id. –û–±–Ω–æ–≤–∏ –±—ç–∫–µ–Ω–¥ /spin.');
        btn.disabled = false;
        pendingPrize = null;
        refreshRecentWins();
        return;
      }

      claimImg.src = (prize && prize.icon_url) ? String(prize.icon_url).trim() : giftImageById(prize.id);
      claimName.textContent = prize.name || '–ü–æ–¥–∞—Ä–æ–∫';
      claimMeta.textContent = `–ü—Ä–æ–¥–∞—Ç—å –∑–∞ ‚≠ê ${prize.cost} –∏–ª–∏ –∑–∞–±—Ä–∞—Ç—å –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å`;

      claimBackdrop.style.display = 'block';
      claimSheet.style.display = 'block';

      claimBackdrop.onclick = (e) => { try { e.preventDefault(); } catch (_) {} };
      try { tg?.HapticFeedback?.notificationOccurred('success'); } catch (_) {}
    }

    function closeClaimIfAllowed() {
      claimBackdrop.style.display = 'none';
      claimSheet.style.display = 'none';
      setTimeout(() => {
        if (pendingSpinId) {
          claimBackdrop.style.display = 'block';
          claimSheet.style.display = 'block';
        }
      }, 50);
    }

    claimClose.addEventListener('click', closeClaimIfAllowed);
    claimClose.addEventListener('touchend', (e) => { e.preventDefault(); closeClaimIfAllowed(); }, { passive: false });

    async function doClaim(action) {
      btnSell.disabled = true;
      btnKeep.disabled = true;

      try {
        const res = await apiPost('/claim', {
          initData: tg?.initData || '',
          spin_id: pendingSpinId,
          action
        });

        if (balanceBadge && res && typeof res.balance === 'number') {
          balanceBadge.textContent = `‚≠ê ${res.balance}`;
        } else {
          refreshBalance();
        }

        if (action === 'keep') {
          await refreshInventory();
        }

        claimBackdrop.style.display = 'none';
        claimSheet.style.display = 'none';

        pendingSpinId = null;
        pendingPrize = null;
        refreshRecentWins();
        btn.disabled = false;

      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
      } finally {
        btnSell.disabled = false;
        btnKeep.disabled = false;
      }
    }

    const onSell = (e) => { try { e.preventDefault(); e.stopPropagation(); } catch (_) {} doClaim('sell'); };
    const onKeep = (e) => { try { e.preventDefault(); e.stopPropagation(); } catch (_) {} doClaim('keep'); };

    btnSell.addEventListener('click', onSell);
    btnSell.addEventListener('touchend', onSell, { passive: false });

    btnKeep.addEventListener('click', onKeep);
    btnKeep.addEventListener('touchend', onKeep, { passive: false });

    // ===== Infinite roulette =====
    const r = roulette || document.querySelector('.roulette');

    function initInfiniteRoulette() {
      if (!r || r.dataset.initialized === 'true') return;

      const items = Array.from(r.children);
      if (!items.length) return;

      items.forEach(el => r.appendChild(el.cloneNode(true)));
      items.forEach(el => r.appendChild(el.cloneNode(true)));

      r._third = () => r.scrollWidth / 3;
      requestAnimationFrame(() => { r.scrollLeft = r._third(); });

      r.dataset.initialized = 'true';
    }

    function normalizeInfinite() {
      if (!r || r.dataset.initialized !== 'true') return 0;
      const third = r._third ? r._third() : (r.scrollWidth / 3);
      if (!third) return 0;

      if (r.scrollLeft < third * 0.35) { r.scrollLeft += third; return third; }
      if (r.scrollLeft > third * 1.65) { r.scrollLeft -= third; return -third; }
      return 0;
    }

    function pickForwardTarget(prizeId) {
      const items = Array.from(r.querySelectorAll('.item'));
      const candidates = items.filter(i => i.dataset.id == prizeId);
      if (!candidates.length) return null;

      const viewportCenter = r.scrollLeft + (r.clientWidth / 2);
      const minLeadPx = r.clientWidth * 0.9;

      let target = null;
      let best = Infinity;

      for (const c of candidates) {
        const center = c.offsetLeft + (c.clientWidth / 2);
        const delta = center - viewportCenter;
        if (delta >= minLeadPx && delta < best) { best = delta; target = c; }
      }

      if (!target) {
        r.scrollLeft += r.scrollWidth / 3;
        const vc2 = r.scrollLeft + (r.clientWidth / 2);
        best = Infinity;
        for (const c of candidates) {
          const center = c.offsetLeft + (c.clientWidth / 2);
          const delta = center - vc2;
          if (delta >= 0 && delta < best) { best = delta; target = c; }
        }
      }

      return target || candidates[0];
    }

    function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

    async function spinToPrize(prize) {
      initInfiniteRoulette();

      r.dataset.lockScroll = 'true';
      r.style.pointerEvents = 'none';

      r.querySelectorAll('.item.win').forEach(el => el.classList.remove('win'));

      const SPIN_MS = 2200;
      const speed = 1.35;
      let startScroll = r.scrollLeft;
      const spinDistance = SPIN_MS * speed;

      await new Promise((resolve) => {
        const t0 = performance.now();
        const tick = (now) => {
          const p = Math.min(1, (now - t0) / SPIN_MS);
          r.scrollLeft = startScroll + spinDistance * p;
          const shift = normalizeInfinite();
          if (shift) startScroll += shift;
          if (p < 1) requestAnimationFrame(tick);
          else resolve();
        };
        requestAnimationFrame(tick);
      });

      const target = pickForwardTarget(prize.id);
      if (!target) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω item –¥–ª—è –ø—Ä–∏–∑–∞');

      let to = (target.offsetLeft + target.clientWidth / 2) - (r.clientWidth / 2);
      let from = r.scrollLeft;
      const STOP_MS = 1600;

      await new Promise((resolve) => {
        const t1 = performance.now();
        const tick = (now) => {
          const p = Math.min(1, (now - t1) / STOP_MS);
          r.scrollLeft = from + (to - from) * easeOutCubic(p);
          const shift = normalizeInfinite();
          if (shift) { from += shift; to += shift; }
          if (p < 1) requestAnimationFrame(tick);
          else resolve();
        };
        requestAnimationFrame(tick);
      });

      target.classList.add('win');
      try { tg?.HapticFeedback?.notificationOccurred('success'); } catch (_) {}

      r.dataset.lockScroll = 'false';
      r.style.pointerEvents = '';
    }

    if (btn && r) {
      const blockScroll = (e) => { try { e.preventDefault(); } catch (_) {} };
      r.addEventListener('touchstart', blockScroll, { passive: false });
      r.addEventListener('touchmove', blockScroll, { passive: false });
      r.addEventListener('wheel', blockScroll, { passive: false });

      btn.addEventListener('click', async () => {
        if (pendingSpinId && pendingPrize) {
          openClaim(pendingPrize);
          return;
        }

        btn.disabled = true;
        try {
          const prize = await apiPost('/spin', { initData: tg?.initData || '', case_id: selectedCaseId });

          if (balanceBadge && prize && typeof prize.balance === 'number') {
            balanceBadge.textContent = `‚≠ê ${prize.balance}`;
          }

          await spinToPrize(prize);
          openClaim(prize);
          setTimeout(refreshRecentWins, 300);

        } catch (e) {
          alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
          btn.disabled = false;
          r.dataset.lockScroll = 'false';
          r.style.pointerEvents = '';
        }
      });
      (async () => {
  try {
    await refreshPrizes();
    initInfiniteRoulette();
    refreshBalance();
    refreshRecentWins();
    setInterval(refreshRecentWins, 12000);
    refreshInventory();
    setTab('spin');
  } catch (e) {
    console.warn('init failed', e);
    try { alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + (e?.message || e)); } catch (_) {}
  }
})();
    } else {
      console.warn('spinBtn –∏–ª–∏ roulette –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
    }
  </script>
</body>
</html>
