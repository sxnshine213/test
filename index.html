<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Random Gift</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0b0f; color:#e9e9f1; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 14px; }
    .row { display:flex; gap:10px; align-items:center; }
    .space { flex:1; }
    .card { background:#141420; border:1px solid #23233a; border-radius:14px; padding:12px; box-shadow: 0 10px 24px rgba(0,0,0,.25); }
    .muted { color:#9aa0b4; font-size: 13px; }
    .title { font-weight: 700; font-size: 18px; }
    .tabs { display:flex; gap:8px; margin-top: 12px; }
    .tab { flex:1; padding:10px; border-radius: 12px; border:1px solid #2a2a43; background:#12121c; color:#d9daf0; cursor:pointer; }
    .tab.active { background:#1c1c2c; border-color:#3a3a5f; }
    button { padding:10px 12px; border-radius: 12px; border:1px solid #2a2a43; background:#1c1c2c; color:#fff; cursor:pointer; }
    button.primary { background:#3a66ff; border-color:#3a66ff; }
    button.danger { background:#b33434; border-color:#b33434; }
    button.ghost { background:transparent; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .grid { display:grid; grid-template-columns: 1fr; gap:10px; }
    .case { display:flex; gap:10px; align-items:center; }
    .pill { font-size: 12px; border:1px solid #2a2a43; padding:4px 8px; border-radius: 999px; color:#cfd2ff; }
    .casesGrid { display:grid; grid-template-columns: 1fr; gap:10px; margin-top: 10px; }
    .caseBtn { width:100%; text-align:left; }
    .prizes { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:10px; }
    .prize { background:#11111a; border:1px solid #24243a; border-radius:12px; padding:10px; }
    .prize img { width: 44px; height:44px; border-radius: 10px; object-fit: cover; background:#0e0e15; border:1px solid #23233a; }
    .prize .name { font-weight:600; margin-top:6px; }
    .prize .meta { font-size:12px; color:#9aa0b4; }
    .invItem { display:flex; gap:10px; align-items:flex-start; }
    .invItem img { width: 48px; height:48px; border-radius: 10px; object-fit: cover; border:1px solid #23233a; background:#0e0e15; }
    .invActions { display:flex; gap:8px; margin-top: 8px; }
    .err { margin-top: 10px; padding:10px; border-radius: 12px; border:1px solid #5a2a2a; background:#1a0f10; color:#ffd0d0; display:none; white-space: pre-wrap; }
    .ok { margin-top: 10px; padding:10px; border-radius: 12px; border:1px solid #2a5a34; background:#0f1a12; color:#d0ffe0; display:none; white-space: pre-wrap; }
    .small { font-size: 12px; }
    .hr { height:1px; background:#24243a; margin: 10px 0; }
    a { color:#9fb2ff; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <div class="title">Random Gift</div>
        <div class="muted">Выбирай кейс, крути, продавай или выводи.</div>
      </div>
      <div class="space"></div>
      <div class="pill">Баланс: <span id="balance">0</span> ⭐</div>
    </div>
    <div class="tabs">
      <button class="tab active" id="tabSpin" type="button">Кейсы</button>
      <button class="tab" id="tabInv" type="button">Инвентарь</button>
    </div>
  </div>

  <div id="msgOk" class="ok"></div>
  <div id="msgErr" class="err"></div>

  <div id="screenSpin" class="card" style="margin-top:12px;">
    <div class="row">
      <div>
        <div class="title" style="font-size:16px;">Кейсы</div>
        <div class="muted">Выбери кейс — у каждого своя цена и призы.</div>
      </div>
      <div class="space"></div>
      <button id="btnReload" type="button" class="ghost">Обновить</button>
    </div>

    <div id="casesList" class="casesGrid"></div>

    <div class="hr"></div>

    <div class="row">
      <div>
        <div class="title" style="font-size:16px;">Выбран: <span id="selectedCaseName">—</span></div>
        <div class="muted">Цена: <span id="selectedCasePrice">—</span> ⭐</div>
      </div>
      <div class="space"></div>
      <button id="btnSpin" type="button" class="primary" disabled>Крутить</button>
    </div>

    <div id="prizesHint" class="muted small" style="margin-top:10px;">Призы выбранного кейса:</div>
    <div id="prizesGrid" class="prizes"></div>
  </div>

  <div id="screenInv" class="card" style="margin-top:12px; display:none;">
    <div class="row">
      <div>
        <div class="title" style="font-size:16px;">Инвентарь</div>
        <div class="muted">Продай за ⭐ или выведи подарок.</div>
      </div>
      <div class="space"></div>
      <button id="btnInvReload" type="button" class="ghost">Обновить</button>
    </div>
    <div id="invEmpty" class="muted" style="margin-top:10px; display:none;">Инвентарь пуст.</div>
    <div id="invList" class="grid" style="margin-top:10px;"></div>
  </div>

</div>

<script>
  const API_BASE = (window.API_BASE || "https://test-u2mr.onrender.com").replace(/\/+$/,'');
  const tg = window.Telegram?.WebApp;

  function showErr(text) {
    const el = document.getElementById('msgErr');
    el.textContent = String(text || 'Ошибка');
    el.style.display = 'block';
    document.getElementById('msgOk').style.display = 'none';
  }
  function showOk(text) {
    const el = document.getElementById('msgOk');
    el.textContent = String(text || 'OK');
    el.style.display = 'block';
    document.getElementById('msgErr').style.display = 'none';
  }
  function clearMsg() {
    document.getElementById('msgOk').style.display = 'none';
    document.getElementById('msgErr').style.display = 'none';
  }

  function initData() {
    return tg?.initData || "";
  }

  async function postJSON(path, body) {
    const url = API_BASE + path;
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body || {}),
    });
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
    if (!res.ok) {
      const msg = (data && (data.detail || data.error || data.message)) ? (data.detail || data.error || data.message) : (res.status + " " + res.statusText);
      throw new Error(msg);
    }
    return data;
  }

  let me = null;
  let cases = [];
  let selectedCaseId = null;
  let selectedCase = null;

  function setActiveTab(which) {
    const spin = document.getElementById('screenSpin');
    const inv = document.getElementById('screenInv');
    const tSpin = document.getElementById('tabSpin');
    const tInv = document.getElementById('tabInv');
    if (which === 'inv') {
      spin.style.display = 'none';
      inv.style.display = 'block';
      tSpin.classList.remove('active');
      tInv.classList.add('active');
    } else {
      spin.style.display = 'block';
      inv.style.display = 'none';
      tInv.classList.remove('active');
      tSpin.classList.add('active');
    }
  }

  function renderCases() {
    const box = document.getElementById('casesList');
    if (!cases.length) {
      box.innerHTML = '<div class="muted">Кейсы не найдены. Создай их в админке.</div>';
      return;
    }
    box.innerHTML = cases.map(c => {
      const active = (String(c.id) === String(selectedCaseId));
      const title = escapeHtml(c.name || ('Case #' + c.id));
      const desc = escapeHtml(c.description || '');
      return `
        <button type="button" class="card caseBtn ${active ? '' : ''}" data-action="select-case" data-case-id="${c.id}">
          <div class="case">
            <div class="space">
              <div style="font-weight:700;">${title}</div>
              ${desc ? `<div class="muted small">${desc}</div>` : ''}
              <div class="muted small" style="margin-top:6px;">Цена: <b>${Number(c.price)||0} ⭐</b></div>
            </div>
            <div class="pill">${active ? 'Выбран' : 'Выбрать'}</div>
          </div>
        </button>
      `;
    }).join('');
  }

  function renderSelectedCase() {
    const nameEl = document.getElementById('selectedCaseName');
    const priceEl = document.getElementById('selectedCasePrice');
    const btnSpin = document.getElementById('btnSpin');
    if (!selectedCase) {
      nameEl.textContent = '—';
      priceEl.textContent = '—';
      btnSpin.disabled = true;
      document.getElementById('prizesGrid').innerHTML = '';
      return;
    }
    nameEl.textContent = selectedCase.name || ('Case #' + selectedCase.id);
    priceEl.textContent = Number(selectedCase.price)||0;
    btnSpin.disabled = false;
  }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderPrizes(items) {
    const grid = document.getElementById('prizesGrid');
    if (!items || !items.length) {
      grid.innerHTML = '<div class="muted">Нет призов для этого кейса.</div>';
      return;
    }
    grid.innerHTML = items.map(p => {
      const img = p.icon_url ? `<img src="${escapeHtml(p.icon_url)}" alt="">` : `<img src="" alt="">`;
      return `
        <div class="prize">
          ${img}
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="meta">${Number(p.cost)||0} ⭐</div>
        </div>
      `;
    }).join('');
  }

  async function loadMe() {
    const data = await postJSON('/me', { initData: initData() });
    me = data;
    document.getElementById('balance').textContent = Number(data.balance)||0;
  }

  async function loadCases() {
    const data = await postJSON('/cases', { initData: initData() });
    cases = data.items || [];
    if (!selectedCaseId && cases.length) {
      selectedCaseId = cases[0].id;
      selectedCase = cases[0];
    } else {
      selectedCase = cases.find(c => String(c.id) === String(selectedCaseId)) || null;
    }
    renderCases();
    renderSelectedCase();
    await loadCasePrizes();
  }

  async function loadCasePrizes() {
    if (!selectedCaseId) {
      renderPrizes([]);
      return;
    }
    const data = await postJSON('/case_prizes', { initData: initData(), case_id: selectedCaseId });
    renderPrizes(data.items || []);
  }

  async function spin() {
    clearMsg();
    if (!selectedCaseId) return;
    const data = await postJSON('/spin', { initData: initData(), case_id: selectedCaseId });
    document.getElementById('balance').textContent = Number(data.balance)||0;
    showOk(`Выпало: ${data.prize?.name || 'приз'} (${data.prize?.cost || 0} ⭐). Добавлено в инвентарь.`);
  }

  async function loadInventory() {
    const data = await postJSON('/inventory', { initData: initData() });
    const items = data.items || [];
    const empty = document.getElementById('invEmpty');
    const list = document.getElementById('invList');
    if (!items.length) {
      empty.style.display = 'block';
      list.innerHTML = '';
      return;
    }
    empty.style.display = 'none';
    list.innerHTML = items.map(it => {
      const img = it.icon_url ? `<img src="${escapeHtml(it.icon_url)}" alt="">` : `<img src="" alt="">`;
      const locked = !!it.is_locked;
      const lockNote = locked ? `<div class="muted small">Статус: в обработке</div>` : '';
      return `
        <div class="card">
          <div class="invItem">
            ${img}
            <div class="space">
              <div style="font-weight:700;">${escapeHtml(it.name || it.prize_name)}</div>
              <div class="muted small">${Number(it.cost ?? it.prize_cost) || 0} ⭐</div>
              ${lockNote}
              <div class="invActions">
                <button type="button" data-action="sell" data-inventory-id="${it.inventory_id || it.id}" ${locked ? 'disabled' : ''}>Продать</button>
                <button type="button" class="primary" data-action="withdraw" data-inventory-id="${it.inventory_id || it.id}" ${locked ? 'disabled' : ''}>Вывести</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  async function sellItem(inventoryId) {
    clearMsg();
    const data = await postJSON('/inventory/sell', { initData: initData(), inventory_id: inventoryId });
    document.getElementById('balance').textContent = Number(data.balance)||0;
    showOk('Продано. Баланс обновлён.');
    await loadInventory();
  }

  async function withdrawItem(inventoryId) {
    clearMsg();
    const data = await postJSON('/inventory/withdraw', { initData: initData(), inventory_id: inventoryId });
    // server returns status/message and maybe balance
    if (data.balance !== undefined) document.getElementById('balance').textContent = Number(data.balance)||0;
    showOk(data.message || 'Запрос обработан.');
    await loadInventory();
  }

  function wireUI() {
    document.getElementById('tabSpin').addEventListener('click', () => setActiveTab('spin'));
    document.getElementById('tabInv').addEventListener('click', async () => { setActiveTab('inv'); await loadInventory(); });
    document.getElementById('btnReload').addEventListener('click', async () => { clearMsg(); await loadCases(); });
    document.getElementById('btnInvReload').addEventListener('click', async () => { clearMsg(); await loadInventory(); });
    document.getElementById('btnSpin').addEventListener('click', async () => { try { await spin(); } catch(e){ showErr(e.message); } });

    document.getElementById('casesList').addEventListener('click', async (ev) => {
      const btn = ev.target.closest('[data-action="select-case"]');
      if (!btn) return;
      selectedCaseId = btn.getAttribute('data-case-id');
      selectedCase = cases.find(c => String(c.id) === String(selectedCaseId)) || null;
      renderCases();
      renderSelectedCase();
      try { await loadCasePrizes(); } catch(e){ showErr(e.message); }
    });

    document.getElementById('invList').addEventListener('click', async (ev) => {
      const b = ev.target.closest('button[data-action]');
      if (!b) return;
      const action = b.getAttribute('data-action');
      const id = b.getAttribute('data-inventory-id');
      if (!id) return;
      b.disabled = true;
      try {
        if (action === 'sell') await sellItem(id);
        else if (action === 'withdraw') await withdrawItem(id);
      } catch (e) {
        showErr(e.message);
      } finally {
        b.disabled = false;
      }
    });
  }

  async function boot() {
    try {
      tg?.ready?.();
      tg?.expand?.();
      wireUI();
      await loadMe();
      await loadCases();
    } catch (e) {
      showErr(e.message || e);
    }
  }

  document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
