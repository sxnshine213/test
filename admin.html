<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin ‚Ä¢ Roulette</title>
  <style>
    body{margin:0;font-family:Inter,Arial,sans-serif;background:#0b1320;color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:#162235;border-radius:14px;padding:14px;margin-top:12px}
    input,button{border-radius:12px;border:1px solid #1f324a;background:#0b1320;color:#fff;padding:10px 12px}
    button{cursor:pointer;border:0;background:#5b8ecb;font-weight:900}
    button.secondary{background:#1f324a}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid #1f324a;vertical-align:top}
    th{opacity:.8;text-align:left}
    .muted{opacity:.75}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0b1320;border:1px solid #1f324a;font-size:12px}
    .ok{color:#7CFC90}
    .bad{color:#ff7b7b}
      .prize-preview{width:34px;height:34px;border-radius:8px;object-fit:cover;background:rgba(255,255,255,.08)}
    tr.dirty{box-shadow: inset 0 0 0 2px rgba(255,196,0,.35)}
    .btn-xs{padding:8px 10px;border-radius:10px;font-weight:900;font-size:12px}
    .btn-danger{background:#B64444}
    td.mini{font-size:11px;opacity:.7;white-space:nowrap}
    .prize-tools textarea{width:100%;min-height:160px;border-radius:12px;border:1px solid #1f324a;background:#0b1320;color:#fff;padding:10px 12px;resize:vertical}
    </style>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 10px 0;">üõ†Ô∏è Admin</h2>

  <div class="card">
    <div class="row">
      <div class="muted">API:</div>
      <input id="apiBase" style="min-width:340px;flex:1" placeholder="https://test-u2mr.onrender.com"/>
      <div class="muted">ADMIN KEY:</div>
      <input id="adminKey" style="min-width:260px;flex:1" placeholder="–≤—Å—Ç–∞–≤—å –∫–ª—é—á"/>
      <button id="saveCfg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="secondary" id="loadStats">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
    </div>
    <div id="cfgHint" class="muted" style="margin-top:10px;">
      –ö–ª—é—á –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ <span class="pill">X-Admin-Key</span>. –ù–µ –ø—É–±–ª–∏–∫—É–π admin.html —Å –∫–ª—é—á–æ–º –≤–Ω—É—Ç—Ä–∏.
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div id="statsStatus" class="muted"></div>
    </div>
    <div id="statsBox" class="row" style="margin-top:10px;gap:12px;"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
    <div class="row" style="margin-top:10px;">
      <input id="userId" placeholder="tg_user_id (—á–∏—Å–ª–æ)" style="min-width:240px;"/>
      <button id="loadUser">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <input id="delta" placeholder="delta (+100 / -50)" style="width:160px"/>
      <button class="secondary" id="applyDelta">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
      <div id="userStatus" class="muted"></div>
    </div>
    <div id="userBox" class="muted" style="margin-top:10px;"></div>
    <div id="userTables"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">üéÅ –ü—Ä–∏–∑—ã</div>
      <button class="secondary" id="loadPrizes">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <input id="prizeSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ id / name / gift_id" style="min-width:220px;flex:2"/>
      <label class="muted" style="display:flex;align-items:center;gap:8px;">
        <input id="prizeShowInactive" type="checkbox" style="width:auto;"/>
        –ø–æ–∫–∞–∑–∞—Ç—å inactive
      </label>
      <button class="secondary" id="saveAllPrizes" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
      <button class="secondary" id="exportPrizes">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <button class="secondary" id="toggleImportPrizes">–ò–º–ø–æ—Ä—Ç JSON</button>
      <div id="prizesDirtyHint" class="muted"></div>
    </div>

    <div id="importPrizesWrap" class="card prize-tools" style="display:none;background:#0f1a2b;">
      <div class="muted" style="margin-bottom:8px;">–í—Å—Ç–∞–≤—å JSON –º–∞—Å—Å–∏–≤–∞ –ø—Ä–∏–∑–æ–≤. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω id –∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –æ–±–Ω–æ–≤–∏–º, –µ—Å–ª–∏ id –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—ã–π.</div>
      <textarea id="importPrizesText"></textarea>
      <div class="row" style="margin-top:10px;justify-content:flex-end;">
        <button class="secondary" id="cancelImportPrizes">–û—Ç–º–µ–Ω–∞</button>
        <button id="applyImportPrizes">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <input id="prizeName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä üíé –ê–ª–º–∞–∑)" style="min-width:220px;flex:2"/>
      <input id="prizeIconUrl" placeholder="Icon URL (https://.../icon.png)" style="min-width:260px;flex:3"/>
      <input id="prizeCost" placeholder="cost" style="width:120px"/>
      <input id="prizeWeight" placeholder="weight" style="width:120px"/>
      <input id="prizeSort" placeholder="sort" style="width:120px"/>
      <input id="prizeGiftId" placeholder="gift_id (Telegram)" style="min-width:180px;flex:2"/>
      <label class="muted" style="display:flex;align-items:center;gap:8px;">
        <input id="prizeUnique" type="checkbox" style="width:auto;"/>
        unique
      </label>
      <label class="muted" style="display:flex;align-items:center;gap:8px;">
        <input id="prizeActive" type="checkbox" checked style="width:auto;"/>
        active
      </label>
      <button id="createPrize">–°–æ–∑–¥–∞—Ç—å</button>
      <div id="prizesStatus" class="muted"></div>
    </div>

    <div id="prizesBox"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">üì¶ –ö–µ–π—Å—ã</div>
      <button class="secondary" id="loadCases">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <input id="caseName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–µ–π—Å–∞" style="min-width:200px;flex:2"/>
      <input id="caseDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" style="min-width:240px;flex:3"/>
      <input id="casePrice" placeholder="price (‚≠ê)" style="width:140px"/>
      <input id="caseSort" placeholder="sort" style="width:120px"/>
      <label class="muted" style="display:flex;align-items:center;gap:8px;">
        <input id="caseActive" type="checkbox" checked style="width:auto;"/>
        active
      </label>
      <button id="createCase">–°–æ–∑–¥–∞—Ç—å</button>
      <div id="casesStatus" class="muted"></div>
    </div>

    <div id="casesBox"></div>
    <div id="casePrizesBox" style="margin-top:12px;"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">üßæ Claims (—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏)</div>
      <div class="row" style="gap:8px;">
        <select id="claimsStatus" class="secondary" style="padding:8px 10px;border-radius:12px;">
          <option value="pending">pending</option>
          <option value="approved">approved</option>
          <option value="rejected">rejected</option>
          <option value="fulfilled">fulfilled</option>
        </select>
        <button class="secondary" id="loadClaims">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>
    <div id="claimsBox"></div>
  </div>




  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">üí≥ Topups</div>
      <button class="secondary" id="loadTopups">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    <div id="topupsBox"></div>
  </div>
</div>

<script>
  const apiBaseEl = document.getElementById('apiBase');
  const adminKeyEl = document.getElementById('adminKey');

  const statsBox = document.getElementById('statsBox');
  const statsStatus = document.getElementById('statsStatus');

  const userIdEl = document.getElementById('userId');
  const deltaEl = document.getElementById('delta');
  const userStatus = document.getElementById('userStatus');
  const userBox = document.getElementById('userBox');
  const userTables = document.getElementById('userTables');

  const topupsBox = document.getElementById('topupsBox');
  const prizesBox = document.getElementById('prizesBox');
  const prizesStatus = document.getElementById('prizesStatus');
  const prizeNameEl = document.getElementById('prizeName');
  const prizeIconUrlEl = document.getElementById('prizeIconUrl');
  const prizeCostEl = document.getElementById('prizeCost');
  const prizeWeightEl = document.getElementById('prizeWeight');
  const prizeSortEl = document.getElementById('prizeSort');

  const prizeGiftIdEl = document.getElementById('prizeGiftId');
  const prizeUniqueEl = document.getElementById('prizeUnique');
  const prizeActiveEl = document.getElementById('prizeActive');

  // Prize editor tools
  const prizeSearchEl = document.getElementById('prizeSearch');
  const prizeShowInactiveEl = document.getElementById('prizeShowInactive');
  const saveAllPrizesBtn = document.getElementById('saveAllPrizes');
  const exportPrizesBtn = document.getElementById('exportPrizes');
  const toggleImportPrizesBtn = document.getElementById('toggleImportPrizes');
  const importPrizesWrap = document.getElementById('importPrizesWrap');
  const importPrizesText = document.getElementById('importPrizesText');
  const applyImportPrizesBtn = document.getElementById('applyImportPrizes');
  const cancelImportPrizesBtn = document.getElementById('cancelImportPrizes');
  const prizesDirtyHint = document.getElementById('prizesDirtyHint');

  const prizesDirty = new Set();
  const prizesDirtyBodies = new Map();
  let prizesCache = [];


  function loadCfg() {
    apiBaseEl.value = localStorage.getItem('admin_api_base') || 'https://test-u2mr.onrender.com';
    adminKeyEl.value = localStorage.getItem('admin_key') || '';
  }

  function saveCfg() {
    localStorage.setItem('admin_api_base', apiBaseEl.value.trim());
    localStorage.setItem('admin_key', adminKeyEl.value.trim());
  }

  function fmtTime(ts) {
    if (!ts) return '';
    try { return new Date(ts * 1000).toLocaleString(); } catch (_) { return String(ts); }
  }

  async function api(path, opts={}) {
  let base = (apiBaseEl.value || '').trim();
  if (!base) throw new Error('–ù–µ —É–∫–∞–∑–∞–Ω API base.');
  if (!/^https?:\/\//i.test(base)) base = 'https://' + base;
  base = base.replace(/\/$/, '');

  if (location.protocol === 'https:' && /^http:\/\//i.test(base)) {
    throw new Error('API base –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å http:// ‚Äî –±—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å (mixed content). –ò—Å–ø–æ–ª—å–∑—É–π https://');
  }

  const key = adminKeyEl.value.trim();
  let res;
  try {
    res = await fetch(base + path, {
      ...opts,
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Key': key,
        ...(opts.headers || {})
      }
    });
  } catch (e) {
    throw new Error(`Failed to fetch ‚Ä¢ base=${base} ‚Ä¢ ${e?.message || e}`);
  }

  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch (_) { data = text; }
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${typeof data === 'string' ? data : JSON.stringify(data)}`);
  return data;
}


  function statCard(title, value) {
    const div = document.createElement('div');
    div.className = 'pill';
    div.style.padding = '10px 12px';
    div.innerHTML = `<div class="muted" style="font-size:12px">${title}</div><div style="font-weight:900;font-size:16px;margin-top:4px">${value}</div>`;
    return div;
  }

  async function loadStats() {
    statsStatus.textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
    statsBox.innerHTML = '';
    try {
      const s = await api('/admin/stats');
      statsBox.appendChild(statCard('Users', s.users));
      statsBox.appendChild(statCard('Total balance', s.total_balance));
      statsBox.appendChild(statCard('Spins total', s.spins_total));
      statsBox.appendChild(statCard('Spins 24h', s.spins_24h));
      statsBox.appendChild(statCard('Topups total', s.topups_total));
      statsBox.appendChild(statCard('Topups 24h', s.topups_24h));
      statsBox.appendChild(statCard('Paid stars total', s.paid_stars_total));
      statsBox.appendChild(statCard('Paid stars 24h', s.paid_stars_24h));
      statsStatus.innerHTML = `<span class="ok">OK</span> ‚Ä¢ ${new Date().toLocaleTimeString()}`;
    } catch (e) {
      statsStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  }

  function renderTable(title, cols, rows) {
    const wrap = document.createElement('div');
    wrap.className = 'card';
    wrap.style.marginTop = '12px';
    wrap.style.background = '#0f1a2b';

    const h = document.createElement('div');
    h.style.fontWeight = '900';
    h.textContent = title;

    const t = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    const tbody = document.createElement('tbody');
    rows.forEach(r => {
      const tr = document.createElement('tr');
      r.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell ?? '';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    t.appendChild(thead);
    t.appendChild(tbody);

    wrap.appendChild(h);
    wrap.appendChild(t);
    return wrap;
  }

  async function loadUser() {
    const uid = userIdEl.value.trim();
    if (!uid) return;

    userStatus.textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
    userBox.textContent = '';
    userTables.innerHTML = '';

    try {
      const d = await api('/admin/user/' + encodeURIComponent(uid));

      userBox.innerHTML = `
        <div><span class="pill">tg_user_id</span> <b>${d.user.tg_user_id}</b></div>
        <div style="margin-top:6px;"><span class="pill">balance</span> <b>${d.user.balance}</b></div>
        <div style="margin-top:6px;"><span class="pill">created</span> ${fmtTime(d.user.created_at)}</div>
      `;

      const spinsRows = (d.spins || []).map(s => [
        s.created_at ? fmtTime(s.created_at) : '',
        s.spin_id,
        `${s.bet_cost}`,
        `${s.prize_name} (${s.prize_cost})`,
        s.status
      ]);
      userTables.appendChild(renderTable('Spins (last 30)', ['time','spin_id','bet','prize','status'], spinsRows));

      const invRows = (d.inventory || []).map(i => [
        i.created_at ? fmtTime(i.created_at) : '',
        `${i.prize_name}`,
        `${i.prize_cost}`
      ]);
      userTables.appendChild(renderTable('Inventory (last 30)', ['time','item','cost'], invRows));

      const topRows = (d.topups || []).map(t => [
        fmtTime(t.created_at),
        `${t.stars_amount}`,
        t.status,
        t.paid_at ? fmtTime(t.paid_at) : ''
      ]);
      userTables.appendChild(renderTable('Topups (last 30)', ['created','stars','status','paid_at'], topRows));

      userStatus.innerHTML = `<span class="ok">OK</span>`;
    } catch (e) {
      userStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  }

  async function applyDelta() {
    const uid = userIdEl.value.trim();
    const delta = parseInt(deltaEl.value.trim(), 10);
    if (!uid || !Number.isFinite(delta)) {
      alert('–£–∫–∞–∂–∏ tg_user_id –∏ delta (—á–∏—Å–ª–æ).');
      return;
    }
    userStatus.textContent = '–ø—Ä–∏–º–µ–Ω—è—é...';
    try {
      const res = await api('/admin/adjust_balance', {
        method: 'POST',
        body: JSON.stringify({ tg_user_id: uid, delta })
      });
      userStatus.innerHTML = `<span class="ok">OK</span> ‚Ä¢ new balance: ${res.balance}`;
      await loadUser();
      await loadStats();
    } catch (e) {
      userStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  }

  // ===== Prizes =====
  function markPrizeDirty(id, tr, body) {
    const pid = Number(id);
    prizesDirty.add(pid);
    if (body) prizesDirtyBodies.set(pid, body);
    if (tr) tr.classList.add('dirty');
    if (saveAllPrizesBtn) saveAllPrizesBtn.disabled = prizesDirty.size === 0;
    if (prizesDirtyHint) prizesDirtyHint.textContent = prizesDirty.size ? (`–∏–∑–º–µ–Ω–µ–Ω–æ: ${prizesDirty.size}`) : '';
  }

  function clearPrizeDirty(id, tr) {
    const pid = Number(id);
    prizesDirty.delete(pid);
    prizesDirtyBodies.delete(pid);
    if (tr) tr.classList.remove('dirty');
    if (saveAllPrizesBtn) saveAllPrizesBtn.disabled = prizesDirty.size === 0;
    if (prizesDirtyHint) prizesDirtyHint.textContent = prizesDirty.size ? (`–∏–∑–º–µ–Ω–µ–Ω–æ: ${prizesDirty.size}`) : '';
  }

  function prizeMatches(p, q) {
    if (!q) return true;
    const s = (v) => (v == null ? '' : String(v)).toLowerCase();
    const qq = q.toLowerCase();
    return s(p.id).includes(qq) || s(p.name).includes(qq) || s(p.gift_id).includes(qq);
  }

  // ===== Prizes (editor) =====
function _lc(s){ return String(s ?? '').toLowerCase(); }

function updateDirtyHint(){
  const n = prizesDirty.size;
  saveAllPrizesBtn.disabled = n === 0;
  prizesDirtyHint.textContent = n ? `–∏–∑–º–µ–Ω–µ–Ω–æ: ${n}` : '';
}

function markPrizeDirty(prizeId, body, tr){
  prizesDirty.add(prizeId);
  prizesDirtyBodies.set(prizeId, body);
  tr.classList.add('dirty');
  updateDirtyHint();
}

function clearPrizeDirty(prizeId){
  prizesDirty.delete(prizeId);
  prizesDirtyBodies.delete(prizeId);
  updateDirtyHint();
}

function makeIconPreview(url){
  const img = document.createElement('img');
  img.className = 'prize-preview';
  img.alt = '';
  img.referrerPolicy = 'no-referrer';
  if (url) img.src = url;
  img.onerror = () => { img.removeAttribute('src'); };
  return img;
}

function prizeRow(p) {
  const tr = document.createElement('tr');

  const tdId = document.createElement('td');
  tdId.textContent = String(p.id);

  const tdPrev = document.createElement('td');
  const prev = makeIconPreview(p.icon_url);
  tdPrev.appendChild(prev);

  const tdName = document.createElement('td');
  const name = document.createElement('input');
  name.value = p.name || '';
  name.style.width = '100%';
  tdName.appendChild(name);

  const tdIcon = document.createElement('td');
  const icon = document.createElement('input');
  icon.value = p.icon_url || '';
  icon.placeholder = 'https://...';
  icon.style.width = '260px';
  tdIcon.appendChild(icon);

  const tdCost = document.createElement('td');
  const cost = document.createElement('input');
  cost.type = 'number';
  cost.value = String(p.cost ?? 0);
  cost.style.width = '90px';
  tdCost.appendChild(cost);

  const tdWeight = document.createElement('td');
  const weight = document.createElement('input');
  weight.type = 'number';
  weight.value = String(p.weight ?? 0);
  weight.style.width = '90px';
  tdWeight.appendChild(weight);

  const tdGiftId = document.createElement('td');
  const giftId = document.createElement('input');
  giftId.value = p.gift_id || '';
  giftId.placeholder = 'gift_id';
  giftId.style.width = '150px';
  tdGiftId.appendChild(giftId);

  const tdUnique = document.createElement('td');
  const unique = document.createElement('input');
  unique.type = 'checkbox';
  unique.checked = !!p.is_unique;
  tdUnique.appendChild(unique);

  const tdSort = document.createElement('td');
  const sort = document.createElement('input');
  sort.type = 'number';
  sort.value = String(p.sort_order ?? 0);
  sort.style.width = '90px';
  tdSort.appendChild(sort);

  const tdActive = document.createElement('td');
  const active = document.createElement('input');
  active.type = 'checkbox';
  active.checked = !!p.is_active;
  tdActive.appendChild(active);

  const tdCreated = document.createElement('td');
  tdCreated.className = 'mini';
  tdCreated.textContent = p.created_at ? fmtTime(p.created_at) : '';

  const tdActions = document.createElement('td');
  const btnSave = document.createElement('button');
  btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
  btnSave.className = 'secondary btn-xs';
  btnSave.style.marginRight = '8px';

  const btnDel = document.createElement('button');
  btnDel.textContent = '–£–¥–∞–ª–∏—Ç—å';
  btnDel.className = 'btn-danger btn-xs';

  const collectBody = () => ({
    name: (name.value || '').trim(),
    icon_url: (icon.value || '').trim() || null,
    cost: parseInt(cost.value, 10) || 0,
    weight: parseInt(weight.value, 10) || 0,
    gift_id: (giftId.value || '').trim() || null,
    is_unique: !!unique.checked,
    is_active: !!active.checked,
    sort_order: parseInt(sort.value, 10) || 0
  });

  const onChange = () => {
    const body = collectBody();
    const u = (body.icon_url || '').trim();
    if (u) prev.src = u; else prev.removeAttribute('src');
    markPrizeDirty(p.id, body, tr);
  };

  [name, icon, cost, weight, giftId, sort].forEach(el => el.addEventListener('input', onChange));
  [unique, active].forEach(el => el.addEventListener('change', onChange));

  btnSave.onclick = async () => {
    prizesStatus.textContent = '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    try {
      const body = collectBody();
      if (!body.name) throw new Error('name –ø—É—Å—Ç–æ–π');
      await api('/admin/prizes/' + encodeURIComponent(p.id), { method:'PUT', body: JSON.stringify(body) });
      prizesStatus.innerHTML = '<span class="ok">OK</span>';
      clearPrizeDirty(p.id);
      await loadPrizes();
    } catch (e) {
      prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  };

  btnDel.onclick = async () => {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∑ #' + p.id + '?')) return;
    prizesStatus.textContent = '—É–¥–∞–ª–µ–Ω–∏–µ...';
    try {
      await api('/admin/prizes/' + encodeURIComponent(p.id), { method:'DELETE' });
      prizesStatus.innerHTML = '<span class="ok">OK</span>';
      clearPrizeDirty(p.id);
      await loadPrizes();
    } catch (e) {
      prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  };

  tdActions.appendChild(btnSave);
  tdActions.appendChild(btnDel);

  tr.appendChild(tdId);
  tr.appendChild(tdPrev);
  tr.appendChild(tdName);
  tr.appendChild(tdIcon);
  tr.appendChild(tdCost);
  tr.appendChild(tdWeight);
  tr.appendChild(tdGiftId);
  tr.appendChild(tdUnique);
  tr.appendChild(tdSort);
  tr.appendChild(tdActive);
  tr.appendChild(tdCreated);
  tr.appendChild(tdActions);

  return tr;
}

function renderPrizes(){
  if (!prizesBox) return;
  prizesBox.innerHTML = '';

  const q = _lc(prizeSearchEl?.value || '');
  const showInactive = !!prizeShowInactiveEl?.checked;

  const items = (prizesCache || []).filter(p => {
    if (!showInactive && !p.is_active) return false;
    if (!q) return true;
    const id = String(p.id);
    return id.includes(q) || _lc(p.name).includes(q) || _lc(p.gift_id).includes(q);
  });

  const table = document.createElement('table');
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>id</th><th></th><th>name</th><th>icon_url</th><th>cost</th><th>weight</th><th>gift_id</th><th>unique</th><th>sort</th><th>active</th><th>created</th><th>actions</th></tr>';
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  items.forEach(p => tbody.appendChild(prizeRow(p)));
  table.appendChild(tbody);

  prizesBox.appendChild(table);

  prizesStatus.innerHTML = `<span class="ok">OK</span> ‚Ä¢ ${items.length}${items.length !== (prizesCache||[]).length ? ` / ${ (prizesCache||[]).length }` : ''}`;
  updateDirtyHint();
}

async function loadPrizes() {
  if (!prizesBox) return;
  prizesStatus.textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
  prizesBox.innerHTML = '';
  try {
    const d = await api('/admin/prizes');
    prizesCache = d.items || [];
    prizesDirty.clear();
    prizesDirtyBodies.clear();
    renderPrizes();
  } catch (e) {
    prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
  }
}

async function createPrize() {
  const name = (prizeNameEl?.value || '').trim();
  const cost = parseInt((prizeCostEl?.value || '').trim(), 10);
  const weight = parseInt((prizeWeightEl?.value || '').trim(), 10);
  const sort = parseInt((prizeSortEl?.value || '').trim(), 10);
  const is_active = !!prizeActiveEl?.checked;
  const icon_url = (prizeIconUrlEl?.value || '').trim() || null;

  const gift_id = (prizeGiftIdEl?.value || '').trim() || null;
  const is_unique = !!prizeUniqueEl?.checked;

  if (!name || !Number.isFinite(cost) || !Number.isFinite(weight)) {
    alert('–£–∫–∞–∂–∏ name, cost –∏ weight.');
    return;
  }

  prizesStatus.textContent = '—Å–æ–∑–¥–∞–Ω–∏–µ...';
  try {
    await api('/admin/prizes', {
      method: 'POST',
      body: JSON.stringify({
        name,
        cost,
        weight,
        gift_id,
        is_unique,
        is_active,
        sort_order: Number.isFinite(sort) ? sort : 0,
        icon_url
      })
    });
    prizesStatus.innerHTML = '<span class="ok">OK</span>';
    if (prizeNameEl) prizeNameEl.value = '';
    if (prizeIconUrlEl) prizeIconUrlEl.value = '';
    if (prizeCostEl) prizeCostEl.value = '';
    if (prizeWeightEl) prizeWeightEl.value = '';
    if (prizeSortEl) prizeSortEl.value = '';
    if (prizeGiftIdEl) prizeGiftIdEl.value = '';
    if (prizeUniqueEl) prizeUniqueEl.checked = false;
    if (prizeActiveEl) prizeActiveEl.checked = true;
    await loadPrizes();
  } catch (e) {
    prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
  }
}

async function saveAllPrizes(){
  if (!prizesDirtyBodies.size) return;
  prizesStatus.textContent = `—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (${prizesDirtyBodies.size})...`;
  try {
    for (const [id, body] of prizesDirtyBodies.entries()){
      if (!body.name) throw new Error(`prize #${id}: –ø—É—Å—Ç–æ–π name`);
      await api('/admin/prizes/' + encodeURIComponent(id), { method:'PUT', body: JSON.stringify(body) });
    }
    prizesStatus.innerHTML = '<span class="ok">OK</span> ‚Ä¢ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
    prizesDirty.clear();
    prizesDirtyBodies.clear();
    updateDirtyHint();
    await loadPrizes();
  } catch (e) {
    prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
  }
}

function exportPrizes(){
  const payload = JSON.stringify(prizesCache || [], null, 2);
  const blob = new Blob([payload], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `prizes_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(a.href), 2500);
}

function toggleImportPrizes(){
  importPrizesWrap.style.display = (importPrizesWrap.style.display === 'none' || !importPrizesWrap.style.display) ? 'block' : 'none';
}

async function applyImportPrizes(){
  let arr;
  try { arr = JSON.parse(importPrizesText.value || '[]'); }
  catch (e) { alert('JSON –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è: ' + e.message); return; }

  if (!Array.isArray(arr)) { alert('–ù—É–∂–µ–Ω JSON –º–∞—Å—Å–∏–≤–∞.'); return; }

  prizesStatus.textContent = `–∏–º–ø–æ—Ä—Ç (${arr.length})...`;
  const byId = new Map((prizesCache||[]).map(x => [x.id, x]));
  try {
    for (const it of arr){
      const body = {
        name: String(it.name ?? '').trim(),
        icon_url: (String(it.icon_url ?? '')).trim() || null,
        cost: parseInt(it.cost ?? 0, 10) || 0,
        weight: parseInt(it.weight ?? 0, 10) || 0,
        gift_id: String(it.gift_id ?? '').trim() || null,
        is_unique: !!it.is_unique,
        is_active: it.is_active === undefined ? true : !!it.is_active,
        sort_order: parseInt(it.sort_order ?? 0, 10) || 0,
      };
      if (!body.name) throw new Error('import: —É –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç name');

      const id = parseInt(it.id, 10);
      if (Number.isFinite(id) && byId.has(id)){
        await api('/admin/prizes/' + encodeURIComponent(id), { method:'PUT', body: JSON.stringify(body) });
      } else {
        await api('/admin/prizes', { method:'POST', body: JSON.stringify(body) });
      }
    }

    prizesStatus.innerHTML = '<span class="ok">OK</span> ‚Ä¢ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ';
    importPrizesText.value = '';
    importPrizesWrap.style.display = 'none';
    await loadPrizes();
  } catch (e) {
    prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
  }
}

// Prize editor controls
prizeSearchEl?.addEventListener('input', renderPrizes);
prizeShowInactiveEl?.addEventListener('change', renderPrizes);
saveAllPrizesBtn?.addEventListener('click', saveAllPrizes);
exportPrizesBtn?.addEventListener('click', exportPrizes);
toggleImportPrizesBtn?.addEventListener('click', toggleImportPrizes);
cancelImportPrizesBtn?.addEventListener('click', () => { importPrizesWrap.style.display='none'; });
applyImportPrizesBtn?.addEventListener('click', applyImportPrizes);

async function loadTopups() {

    topupsBox.innerHTML = '<div class="muted">–∑–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      const d = await api('/admin/topups?limit=80');
      const rows = (d.items || []).map(t => ([
        fmtTime(t.created_at),
        t.tg_user_id,
        String(t.stars_amount),
        t.status,
        t.paid_at ? fmtTime(t.paid_at) : '',
      ]));
      topupsBox.innerHTML = '';
      topupsBox.appendChild(renderTable('Topups (last 80)', ['created','user','stars','status','paid_at'], rows));
    } catch (e) {
      topupsBox.innerHTML = `<div class="bad">ERR: ${e.message}</div>`;
    }
  }

  document.getElementById('saveCfg').onclick = () => { saveCfg(); loadStats(); };
  document.getElementById('loadStats').onclick = loadStats;
  document.getElementById('loadUser').onclick = loadUser;
  document.getElementById('applyDelta').onclick = applyDelta;
  document.getElementById('loadTopups').onclick = loadTopups;

  loadCfg();
  loadStats();
  loadTopups();

  document.getElementById('loadPrizes')?.addEventListener('click', loadPrizes);
  document.getElementById('createPrize')?.addEventListener('click', createPrize);

  prizeSearchEl?.addEventListener('input', () => loadPrizes(false));
  prizeShowInactiveEl?.addEventListener('change', () => loadPrizes(false));

  exportPrizesBtn?.addEventListener('click', () => {
    try {
      const blob = new Blob([JSON.stringify(prizesCache || [], null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'prizes.json';
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    } catch (e) { alert('Export error: ' + (e?.message || e)); }
  });

  toggleImportPrizesBtn?.addEventListener('click', () => {
    if (!importPrizesWrap) return;
    importPrizesWrap.style.display = (importPrizesWrap.style.display === 'none' || !importPrizesWrap.style.display) ? 'block' : 'none';
  });
  cancelImportPrizesBtn?.addEventListener('click', () => {
    if (importPrizesWrap) importPrizesWrap.style.display = 'none';
  });

  applyImportPrizesBtn?.addEventListener('click', async () => {
    const raw = (importPrizesText?.value || '').trim();
    if (!raw) return;
    let arr;
    try { arr = JSON.parse(raw); } catch (e) { alert('JSON parse error: ' + e.message); return; }
    if (!Array.isArray(arr)) { alert('–û–∂–∏–¥–∞–µ—Ç—Å—è JSON –º–∞—Å—Å–∏–≤'); return; }
    prizesStatus.textContent = '–∏–º–ø–æ—Ä—Ç...';
    const existing = new Set((prizesCache || []).map(x => Number(x.id)));
    let ok = 0, fail = 0;
    for (const it of arr) {
      try {
        const body = {
          name: String(it.name || '').trim(),
          icon_url: (it.icon_url == null ? null : String(it.icon_url).trim()) || null,
          cost: parseInt(it.cost, 10) || 0,
          weight: parseInt(it.weight, 10) || 0,
          gift_id: (it.gift_id == null ? null : String(it.gift_id).trim()) || null,
          is_unique: !!it.is_unique,
          is_active: (it.is_active === undefined ? true : !!it.is_active),
          sort_order: parseInt(it.sort_order, 10) || 0,
        };
        if (!body.name) throw new Error('name required');
        if (it.id != null && existing.has(Number(it.id))) {
          await api('/admin/prizes/' + encodeURIComponent(Number(it.id)), { method:'PUT', body: JSON.stringify(body) });
        } else {
          await api('/admin/prizes', { method:'POST', body: JSON.stringify(body) });
        }
        ok++;
      } catch (e) {
        console.warn('import prize failed', it, e);
        fail++;
      }
    }
    prizesStatus.innerHTML = `<span class="${fail? 'bad':'ok'}">${fail? 'WARN':'OK'}</span> ‚Ä¢ imported: ${ok}, failed: ${fail}`;
    if (importPrizesWrap) importPrizesWrap.style.display = 'none';
    await loadPrizes();
  });

  saveAllPrizesBtn?.addEventListener('click', async () => {
    if (!prizesDirty.size) return;
    if (!confirm('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (' + prizesDirty.size + ')?')) return;
    prizesStatus.textContent = '—Å–æ—Ö—Ä–∞–Ω—è—é –≤—Å–µ...';
    let ok = 0, fail = 0;
    for (const pid of Array.from(prizesDirty)) {
      try {
        const body = prizesDirtyBodies.get(pid);
        if (!body) continue;
        await api('/admin/prizes/' + encodeURIComponent(pid), { method:'PUT', body: JSON.stringify(body) });
        ok++;
      } catch (e) {
        console.warn('saveAll failed', pid, e);
        fail++;
      }
    }
    prizesStatus.innerHTML = `<span class="${fail? 'bad':'ok'}">${fail? 'WARN':'OK'}</span> ‚Ä¢ saved: ${ok}, failed: ${fail}`;
    await loadPrizes();
  });



  // ===== Cases =====
  const loadCasesBtn = document.getElementById('loadCases');
  const createCaseBtn = document.getElementById('createCase');
  const casesBox = document.getElementById('casesBox');
  const casePrizesBox = document.getElementById('casePrizesBox');
  const casesStatus = document.getElementById('casesStatus');
  const caseNameEl = document.getElementById('caseName');
  const caseDescEl = document.getElementById('caseDesc');
  const casePriceEl = document.getElementById('casePrice');
  const caseSortEl = document.getElementById('caseSort');
  const caseActiveEl = document.getElementById('caseActive');

  let lastCases = [];
  let selectedCaseId = null;
  let allPrizesCache = null;

  async function loadCases(){
    if (!casesBox) return;
    casesStatus.textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
    casesBox.innerHTML = '';
    casePrizesBox.innerHTML = '';
    try{
      const d = await api('/admin/cases');
      lastCases = d.items || [];
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>id</th><th>name</th><th>description</th><th>price</th><th>sort</th><th>active</th><th>actions</th></tr>';
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      lastCases.forEach(c => {
        const tr = document.createElement('tr');

        const tdId = document.createElement('td'); tdId.textContent = String(c.id);

        const tdName = document.createElement('td');
        const name = document.createElement('input'); name.value = c.name || ''; name.style.width = '100%';
        tdName.appendChild(name);

        const tdDesc = document.createElement('td');
        const desc = document.createElement('input'); desc.value = c.description || ''; desc.style.width = '100%';
        tdDesc.appendChild(desc);

        const tdPrice = document.createElement('td');
        const price = document.createElement('input'); price.value = String(c.price ?? 0); price.style.width='110px';
        tdPrice.appendChild(price);

        const tdSort = document.createElement('td');
        const sort = document.createElement('input'); sort.value = String(c.sort_order ?? 0); sort.style.width='90px';
        tdSort.appendChild(sort);

        const tdActive = document.createElement('td');
        const active = document.createElement('input'); active.type='checkbox'; active.checked=!!c.is_active;
        tdActive.appendChild(active);

        const tdAct = document.createElement('td');
        const btnSave = document.createElement('button'); btnSave.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        btnSave.onclick = async () => {
          await api(`/admin/cases/${c.id}`, {
            method: 'PUT',
            body: JSON.stringify({
              name: name.value || '',
              description: (desc.value || '').trim() || null,
              price: parseInt(price.value || '0', 10) || 0,
              is_active: !!active.checked,
              sort_order: parseInt(sort.value || '0', 10) || 0,
            })
          });
          await loadCases();
        };

        const btnManage = document.createElement('button'); btnManage.textContent='–ü—Ä–∏–∑—ã';
        btnManage.className='secondary';
        btnManage.onclick = async () => {
          selectedCaseId = c.id;
          await openCasePrizes(c.id);
        };

        const btnDel = document.createElement('button'); btnDel.textContent='–£–¥–∞–ª–∏—Ç—å';
        btnDel.className='secondary';
        btnDel.onclick = async () => {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–µ–π—Å?')) return;
          await api(`/admin/cases/${c.id}`, { method:'DELETE' });
          await loadCases();
        };

        tdAct.appendChild(btnSave);
        tdAct.appendChild(btnManage);
        tdAct.appendChild(btnDel);

        tr.appendChild(tdId);
        tr.appendChild(tdName);
        tr.appendChild(tdDesc);
        tr.appendChild(tdPrice);
        tr.appendChild(tdSort);
        tr.appendChild(tdActive);
        tr.appendChild(tdAct);

        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      casesBox.appendChild(table);
      casesStatus.textContent = `ok: ${lastCases.length}`;
    }catch(e){
      casesStatus.textContent = '–æ—à–∏–±–∫–∞: ' + (e?.message || e);
    }
  }

  async function openCasePrizes(caseId){
    if (!casePrizesBox) return;
    casePrizesBox.innerHTML = '<div class="muted">–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–∑–æ–≤ –∫–µ–π—Å–∞...</div>';

    if (!allPrizesCache) {
      const d = await api('/admin/prizes');
      allPrizesCache = d.items || [];
    }
    const d2 = await api(`/admin/cases/${caseId}/prizes`);
    const linked = new Map((d2.items || []).map(x => [x.prize_id, x]));

    const wrap = document.createElement('div');
    wrap.innerHTML = `<div style="font-weight:900;margin:8px 0;">–ü—Ä–∏–∑—ã –∫–µ–π—Å–∞ #${caseId}</div>`;

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th>use</th><th>prize_id</th><th>name</th><th>weight</th></tr>';
    table.appendChild(thead);
    const tbody = document.createElement('tbody');

    const rows = [];
    allPrizesCache.forEach(p => {
      const tr = document.createElement('tr');
      const tdUse = document.createElement('td');
      const use = document.createElement('input'); use.type='checkbox'; use.checked = linked.has(p.id);
      tdUse.appendChild(use);

      const tdId = document.createElement('td'); tdId.textContent=String(p.id);
      const tdName = document.createElement('td'); tdName.textContent=p.name || '';
      const tdW = document.createElement('td');
      const w = document.createElement('input');
      w.value = String(linked.get(p.id)?.weight ?? p.weight ?? 0);
      w.style.width='110px';
      tdW.appendChild(w);

      tr.appendChild(tdUse); tr.appendChild(tdId); tr.appendChild(tdName); tr.appendChild(tdW);
      tbody.appendChild(tr);
      rows.push({p, use, w});
    });
    table.appendChild(tbody);
    wrap.appendChild(table);

    const row = document.createElement('div');
    row.className = 'row';
    row.style.marginTop='10px';

    const btnSave = document.createElement('button');
    btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫–∏';
    btnSave.onclick = async () => {
      const payload = rows.filter(r => r.use.checked).map(r => ({
        prize_id: r.p.id,
        weight: parseInt(r.w.value || '0', 10) || 0,
        is_active: true
      }));
      await api(`/admin/cases/${caseId}/prizes`, { method:'POST', body: JSON.stringify(payload) });
      alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.');
      await openCasePrizes(caseId);
    };

    row.appendChild(btnSave);
    wrap.appendChild(row);

    casePrizesBox.innerHTML = '';
    casePrizesBox.appendChild(wrap);
  }

  if (loadCasesBtn) loadCasesBtn.onclick = loadCases;
  if (createCaseBtn) createCaseBtn.onclick = async () => {
    const name = (caseNameEl?.value || '').trim();
    const description = (caseDescEl?.value || '').trim();
    const price = parseInt(casePriceEl?.value || '0', 10);
    const sort = parseInt(caseSortEl?.value || '0', 10) || 0;
    const is_active = !!(caseActiveEl && caseActiveEl.checked);

    if (!name || !Number.isFinite(price) || price <= 0){
      alert('–£–∫–∞–∂–∏ name –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π price.');
      return;
    }

    casesStatus.textContent = '—Å–æ–∑–¥–∞–Ω–∏–µ...';
    try{
      await api('/admin/cases', {
        method:'POST',
        body: JSON.stringify({ name, description: description || null, price, is_active, sort_order: sort })
      });
      caseNameEl.value='';
      caseDescEl.value='';
      casePriceEl.value='';
      caseSortEl.value='';
      caseActiveEl.checked=true;
      await loadCases();
      casesStatus.textContent='ok';
    }catch(e){
      casesStatus.textContent = '–æ—à–∏–±–∫–∞: ' + (e?.message || e);
    }
  };

  // ===== Claims =====
  const loadClaimsBtn = document.getElementById('loadClaims');
  const claimsBox = document.getElementById('claimsBox');
  const claimsStatusSel = document.getElementById('claimsStatus');

  async function loadClaims(){
    if (!claimsBox) return;
    claimsBox.innerHTML = '<div class="muted">–∑–∞–≥—Ä—É–∑–∫–∞...</div>';
    const status = (claimsStatusSel?.value || 'pending');
    try{
      const d = await api(`/admin/claims?status=${encodeURIComponent(status)}`);
      const items = d.items || [];
      if (!items.length){
        claimsBox.innerHTML = '<div class="muted">–ü—É—Å—Ç–æ.</div>';
        return;
      }
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>id</th><th>user</th><th>inventory_id</th><th>prize</th><th>status</th><th>created</th><th>actions</th></tr>';
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      items.forEach(c => {
        const tr = document.createElement('tr');
        const tdId = document.createElement('td'); tdId.textContent=String(c.id);
        const tdU = document.createElement('td'); tdU.textContent=String(c.tg_user_id);
        const tdInv = document.createElement('td'); tdInv.textContent=String(c.inventory_id);
        const tdP = document.createElement('td'); tdP.textContent=`${c.prize_name} (#${c.prize_id})`;
        const tdS = document.createElement('td'); tdS.textContent=String(c.status);
        const tdT = document.createElement('td'); tdT.textContent = c.created_at ? new Date(c.created_at*1000).toLocaleString() : '';
        const tdA = document.createElement('td');

        const mkBtn = (label, path) => {
          const b = document.createElement('button');
          b.textContent = label;
          b.className = 'secondary';
          b.onclick = async () => {
            await api(path, { method:'POST' });
            await loadClaims();
          };
          return b;
        };

        if (status === 'pending'){
          tdA.appendChild(mkBtn('approve', `/admin/claims/${c.id}/approve`));
          tdA.appendChild(mkBtn('reject', `/admin/claims/${c.id}/reject`));
        }
        if (status === 'approved'){
          tdA.appendChild(mkBtn('fulfill', `/admin/claims/${c.id}/fulfill`));
        }
        tr.appendChild(tdId); tr.appendChild(tdU); tr.appendChild(tdInv); tr.appendChild(tdP); tr.appendChild(tdS); tr.appendChild(tdT); tr.appendChild(tdA);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      claimsBox.innerHTML = '';
      claimsBox.appendChild(table);
    }catch(e){
      claimsBox.innerHTML = '<div class="muted">–æ—à–∏–±–∫–∞: ' + (e?.message || e) + '</div>';
    }
  }

  if (loadClaimsBtn) loadClaimsBtn.onclick = loadClaims;
  if (claimsStatusSel) claimsStatusSel.onchange = loadClaims;

</script>
</body>
</html>
