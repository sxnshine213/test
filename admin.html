<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin ‚Ä¢ Roulette</title>
  <style>
    body{margin:0;font-family:Inter,Arial,sans-serif;background:#0b1320;color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:#162235;border-radius:14px;padding:14px;margin-top:12px}
    input,button{border-radius:12px;border:1px solid #1f324a;background:#0b1320;color:#fff;padding:10px 12px}
    button{cursor:pointer;border:0;background:#5b8ecb;font-weight:900}
    button.secondary{background:#1f324a}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid #1f324a;vertical-align:top}
    th{opacity:.8;text-align:left}
    .muted{opacity:.75}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0b1320;border:1px solid #1f324a;font-size:12px}
    .ok{color:#7CFC90}
    .bad{color:#ff7b7b}
  </style>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 10px 0;">üõ†Ô∏è Admin</h2>

  <div class="card">
    <div class="row">
      <div class="muted">API:</div>
      <input id="apiBase" style="min-width:340px;flex:1" placeholder="https://test-u2mr.onrender.com"/>
      <div class="muted">ADMIN KEY:</div>
      <input id="adminKey" style="min-width:260px;flex:1" placeholder="–≤—Å—Ç–∞–≤—å –∫–ª—é—á"/>
      <button id="saveCfg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="secondary" id="loadStats">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
    </div>
    <div id="cfgHint" class="muted" style="margin-top:10px;">
      –ö–ª—é—á –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ <span class="pill">X-Admin-Key</span>. –ù–µ –ø—É–±–ª–∏–∫—É–π admin.html —Å –∫–ª—é—á–æ–º –≤–Ω—É—Ç—Ä–∏.
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div id="statsStatus" class="muted"></div>
    </div>
    <div id="statsBox" class="row" style="margin-top:10px;gap:12px;"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
    <div class="row" style="margin-top:10px;">
      <input id="userId" placeholder="tg_user_id (—á–∏—Å–ª–æ)" style="min-width:240px;"/>
      <button id="loadUser">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <input id="delta" placeholder="delta (+100 / -50)" style="width:160px"/>
      <button class="secondary" id="applyDelta">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
      <div id="userStatus" class="muted"></div>
    </div>
    <div id="userBox" class="muted" style="margin-top:10px;"></div>
    <div id="userTables"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">üí≥ Topups</div>
      <button class="secondary" id="loadTopups">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    <div id="topupsBox"></div>
  
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div style="font-weight:900;">üéÅ Prizes</div>
      <div class="row">
        <button class="secondary" id="loadPrizes">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="addPrize">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
    <div class="muted" style="margin-top:6px;">icon_url –º–æ–∂–µ—Ç –±—ã—Ç—å .webp (—Å—Ç–∞—Ç–∏—á–Ω–æ) –∏–ª–∏ .webm (–∞–Ω–∏–º–∞—Ü–∏—è). –î–ª—è —Å–ø–∏—Å–∫–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–º–µ—Ç—å webp-–≤–µ—Ä—Å–∏—é —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º (example.webp —Ä—è–¥–æ–º —Å example.webm).</div>
    <div id="prizesBox"></div>
    <div id="prizesStatus" class="muted" style="margin-top:8px;"></div>
  </div>
</div>
</div>

<script>
  const apiBaseEl = document.getElementById('apiBase');
  const adminKeyEl = document.getElementById('adminKey');

  const statsBox = document.getElementById('statsBox');
  const statsStatus = document.getElementById('statsStatus');

  const userIdEl = document.getElementById('userId');
  const deltaEl = document.getElementById('delta');
  const userStatus = document.getElementById('userStatus');
  const userBox = document.getElementById('userBox');
  const userTables = document.getElementById('userTables');

  const topupsBox = document.getElementById('topupsBox');

  const prizesBox = document.getElementById('prizesBox');
  const prizesStatus = document.getElementById('prizesStatus');
  const loadPrizesBtn = document.getElementById('loadPrizes');
  const addPrizeBtn = document.getElementById('addPrize');

  function loadCfg() {
    apiBaseEl.value = localStorage.getItem('admin_api_base') || 'https://test-u2mr.onrender.com';
    adminKeyEl.value = localStorage.getItem('admin_key') || '';
  }

  function saveCfg() {
    localStorage.setItem('admin_api_base', apiBaseEl.value.trim());
    localStorage.setItem('admin_key', adminKeyEl.value.trim());
  }

  function fmtTime(ts) {
    if (!ts) return '';
    try { return new Date(ts * 1000).toLocaleString(); } catch (_) { return String(ts); }
  }

  async function api(path, opts={}) {
    const base = apiBaseEl.value.trim().replace(/\/$/, '');
    const key = adminKeyEl.value.trim();
    const res = await fetch(base + path, {
      ...opts,
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Key': key,
        ...(opts.headers || {})
      }
    });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch (_) { data = text; }
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${typeof data === 'string' ? data : JSON.stringify(data)}`);
    return data;
  }

  function statCard(title, value) {
    const div = document.createElement('div');
    div.className = 'pill';
    div.style.padding = '10px 12px';
    div.innerHTML = `<div class="muted" style="font-size:12px">${title}</div><div style="font-weight:900;font-size:16px;margin-top:4px">${value}</div>`;
    return div;
  }

  async function loadStats() {
    statsStatus.textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
    statsBox.innerHTML = '';
    try {
      const s = await api('/admin/stats');
      statsBox.appendChild(statCard('Users', s.users));
      statsBox.appendChild(statCard('Total balance', s.total_balance));
      statsBox.appendChild(statCard('Spins total', s.spins_total));
      statsBox.appendChild(statCard('Spins 24h', s.spins_24h));
      statsBox.appendChild(statCard('Topups total', s.topups_total));
      statsBox.appendChild(statCard('Topups 24h', s.topups_24h));
      statsBox.appendChild(statCard('Paid stars total', s.paid_stars_total));
      statsBox.appendChild(statCard('Paid stars 24h', s.paid_stars_24h));
      statsStatus.innerHTML = `<span class="ok">OK</span> ‚Ä¢ ${new Date().toLocaleTimeString()}`;
    } catch (e) {
      statsStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  }

  function renderTable(title, cols, rows) {
    const wrap = document.createElement('div');
    wrap.className = 'card';
    wrap.style.marginTop = '12px';
    wrap.style.background = '#0f1a2b';

    const h = document.createElement('div');
    h.style.fontWeight = '900';
    h.textContent = title;

    const t = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    const tbody = document.createElement('tbody');
    rows.forEach(r => {
      const tr = document.createElement('tr');
      r.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell ?? '';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    t.appendChild(thead);
    t.appendChild(tbody);

    wrap.appendChild(h);
    wrap.appendChild(t);
    return wrap;
  }

  async function loadUser() {
    const uid = userIdEl.value.trim();
    if (!uid) return;

    userStatus.textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
    userBox.textContent = '';
    userTables.innerHTML = '';

    try {
      const d = await api('/admin/user/' + encodeURIComponent(uid));

      userBox.innerHTML = `
        <div><span class="pill">tg_user_id</span> <b>${d.user.tg_user_id}</b></div>
        <div style="margin-top:6px;"><span class="pill">balance</span> <b>${d.user.balance}</b></div>
        <div style="margin-top:6px;"><span class="pill">created</span> ${fmtTime(d.user.created_at)}</div>
      `;

      const spinsRows = (d.spins || []).map(s => [
        s.created_at ? fmtTime(s.created_at) : '',
        s.spin_id,
        `${s.bet_cost}`,
        `${s.prize_name} (${s.prize_cost})`,
        s.status
      ]);
      userTables.appendChild(renderTable('Spins (last 30)', ['time','spin_id','bet','prize','status'], spinsRows));

      const invRows = (d.inventory || []).map(i => [
        i.created_at ? fmtTime(i.created_at) : '',
        `${i.prize_name}`,
        `${i.prize_cost}`
      ]);
      userTables.appendChild(renderTable('Inventory (last 30)', ['time','item','cost'], invRows));

      const topRows = (d.topups || []).map(t => [
        fmtTime(t.created_at),
        `${t.stars_amount}`,
        t.status,
        t.paid_at ? fmtTime(t.paid_at) : ''
      ]);
      userTables.appendChild(renderTable('Topups (last 30)', ['created','stars','status','paid_at'], topRows));

      userStatus.innerHTML = `<span class="ok">OK</span>`;
    } catch (e) {
      userStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  }

  async function applyDelta() {
    const uid = userIdEl.value.trim();
    const delta = parseInt(deltaEl.value.trim(), 10);
    if (!uid || !Number.isFinite(delta)) {
      alert('–£–∫–∞–∂–∏ tg_user_id –∏ delta (—á–∏—Å–ª–æ).');
      return;
    }
    userStatus.textContent = '–ø—Ä–∏–º–µ–Ω—è—é...';
    try {
      const res = await api('/admin/adjust_balance', {
        method: 'POST',
        body: JSON.stringify({ tg_user_id: uid, delta })
      });
      userStatus.innerHTML = `<span class="ok">OK</span> ‚Ä¢ new balance: ${res.balance}`;
      await loadUser();
      await loadStats();
    } catch (e) {
      userStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  }

  async function loadTopups() {
    topupsBox.innerHTML = '<div class="muted">–∑–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      const d = await api('/admin/topups?limit=80');
      const rows = (d.items || []).map(t => ([
        fmtTime(t.created_at),
        t.tg_user_id,
        String(t.stars_amount),
        t.status,
        t.paid_at ? fmtTime(t.paid_at) : '',
      ]));
      topupsBox.innerHTML = '';
      topupsBox.appendChild(renderTable('Topups (last 80)', ['created','user','stars','status','paid_at'], rows));
    } catch (e) {
      topupsBox.innerHTML = `<div class="bad">ERR: ${e.message}</div>`;
    }
  }


  // ===== Prizes CRUD =====
  function isWebm(url) { return /\.webm(\?|$)/i.test(url || ''); }

  function renderPrizes(items) {
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th>ID</th>
        <th>name</th>
        <th>cost</th>
        <th>weight</th>
        <th>sort</th>
        <th>active</th>
        <th>icon_url</th>
        <th></th>
      </tr>`;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    for (const p of items) {
      const tr = document.createElement('tr');

      const idTd = document.createElement('td');
      idTd.textContent = String(p.id);
      tr.appendChild(idTd);

      const nameTd = document.createElement('td');
      const nameIn = document.createElement('input');
      nameIn.value = p.name || '';
      nameIn.style.minWidth = '180px';
      nameTd.appendChild(nameIn);
      tr.appendChild(nameTd);

      const costTd = document.createElement('td');
      const costIn = document.createElement('input');
      costIn.type = 'number';
      costIn.value = String(p.cost ?? 0);
      costIn.style.width = '90px';
      costTd.appendChild(costIn);
      tr.appendChild(costTd);

      const wTd = document.createElement('td');
      const wIn = document.createElement('input');
      wIn.type = 'number';
      wIn.value = String(p.weight ?? 0);
      wIn.style.width = '90px';
      wTd.appendChild(wIn);
      tr.appendChild(wTd);

      const sTd = document.createElement('td');
      const sIn = document.createElement('input');
      sIn.type = 'number';
      sIn.value = String(p.sort_order ?? 0);
      sIn.style.width = '90px';
      sTd.appendChild(sIn);
      tr.appendChild(sTd);

      const aTd = document.createElement('td');
      const aIn = document.createElement('input');
      aIn.type = 'checkbox';
      aIn.checked = !!p.is_active;
      aTd.appendChild(aIn);
      tr.appendChild(aTd);

      const iconTd = document.createElement('td');
      const iconIn = document.createElement('input');
      iconIn.value = p.icon_url || '';
      iconIn.placeholder = 'https://.../icon.webp –∏–ª–∏ .webm';
      iconIn.style.minWidth = '360px';
      iconTd.appendChild(iconIn);

      const hint = document.createElement('div');
      hint.className = 'muted';
      hint.style.marginTop = '4px';
      hint.style.fontSize = '12px';
      hint.textContent = iconIn.value ? (isWebm(iconIn.value) ? 'webm (–∞–Ω–∏–º–∞—Ü–∏—è)' : 'image') : '';
      iconTd.appendChild(hint);

      tr.appendChild(iconTd);

      const actTd = document.createElement('td');
      const saveBtn = document.createElement('button');
      saveBtn.className = 'secondary';
      saveBtn.textContent = 'Save';
      saveBtn.onclick = async () => {
        try {
          prizesStatus.innerHTML = '<span class="muted">saving...</span>';
          await api('/admin/prizes/' + p.id, {
            method: 'PATCH',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              name: nameIn.value.trim() || null,
              cost: parseInt(costIn.value, 10),
              weight: parseInt(wIn.value, 10),
              sort_order: parseInt(sIn.value, 10),
              is_active: !!aIn.checked,
              icon_url: iconIn.value.trim() || null,
            })
          });
          prizesStatus.innerHTML = '<span class="ok">saved</span>';
          await loadPrizesAdmin();
        } catch (e) {
          prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
        }
      };
      const delBtn = document.createElement('button');
      delBtn.className = 'secondary';
      delBtn.textContent = 'Del';
      delBtn.onclick = async () => {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∑ #' + p.id + '?')) return;
        try {
          prizesStatus.innerHTML = '<span class="muted">deleting...</span>';
          await api('/admin/prizes/' + p.id, { method: 'DELETE' });
          prizesStatus.innerHTML = '<span class="ok">deleted</span>';
          await loadPrizesAdmin();
        } catch (e) {
          prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
        }
      };
      actTd.appendChild(saveBtn);
      actTd.appendChild(document.createElement('div')).style.height = '6px';
      actTd.appendChild(delBtn);
      tr.appendChild(actTd);

      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    return table;
  }

  async function loadPrizesAdmin() {
    if (!prizesBox) return;
    prizesBox.innerHTML = '<div class="muted">–∑–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      const d = await api('/admin/prizes');
      const items = Array.isArray(d.items) ? d.items : [];
      prizesBox.innerHTML = '';
      prizesBox.appendChild(renderPrizes(items));
      prizesStatus.innerHTML = `<span class="ok">OK</span> ‚Ä¢ ${items.length} items`;
    } catch (e) {
      prizesBox.innerHTML = '';
      prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  }

  async function addPrize() {
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞:');
    if (!name) return;
    const cost = parseInt(prompt('–°—Ç–æ–∏–º–æ—Å—Ç—å (sell) –≤ ‚≠ê:', '25') || '25', 10);
    const weight = parseInt(prompt('–í–µ—Å (—à–∞–Ω—Å):', '10') || '10', 10);
    const icon_url = prompt('icon_url (webp/webm), –º–æ–∂–Ω–æ –ø—É—Å—Ç–æ:', '') || '';
    try {
      prizesStatus.innerHTML = '<span class="muted">creating...</span>';
      await api('/admin/prizes', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          name: name.trim(),
          cost: Number.isFinite(cost) ? cost : 0,
          weight: Number.isFinite(weight) ? weight : 0,
          icon_url: icon_url.trim() || null,
          is_active: true,
          sort_order: 0
        })
      });
      prizesStatus.innerHTML = '<span class="ok">created</span>';
      await loadPrizesAdmin();
    } catch (e) {
      prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  }

  document.getElementById('saveCfg').onclick = () => { saveCfg(); loadStats(); };
  document.getElementById('loadStats').onclick = loadStats;
  document.getElementById('loadUser').onclick = loadUser;
  document.getElementById('applyDelta').onclick = applyDelta;
  document.getElementById('loadTopups').onclick = loadTopups;
  if (loadPrizesBtn) loadPrizesBtn.onclick = loadPrizesAdmin;
  if (addPrizeBtn) addPrizeBtn.onclick = addPrize;

  loadCfg();
  loadStats();
  loadTopups();
  loadPrizesAdmin();
</script>
</body>
</html>
