<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin ‚Ä¢ archicasino</title>
  <style>
    body{margin:0;font-family:Inter,Arial,sans-serif;background:#0b1320;color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:#162235;border-radius:14px;padding:14px;margin-top:12px}
    input,button,select{border-radius:12px;border:1px solid #1f324a;background:#0b1320;color:#fff;padding:10px 12px}
    button{cursor:pointer;border:0;background:#5b8ecb;font-weight:900}
    button.secondary{background:#1f324a}
    button.danger{background:#b44a4a}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid #1f324a;vertical-align:top}
    th{opacity:.8;text-align:left}
    .muted{opacity:.75}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0b1320;border:1px solid #1f324a;font-size:12px}
    .ok{color:#7CFC90}
    .bad{color:#ff7b7b}
    .mini{padding:8px 10px;border-radius:10px;font-size:12px}
    .w-100{width:100%}
  </style>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 10px 0;">üõ†Ô∏è Admin</h2>

  <div class="card">
    <div class="row">
      <div class="muted">API:</div>
      <input id="apiBase" style="min-width:340px;flex:1" placeholder="https://test-u2mr.onrender.com"/>
      <div class="muted">ADMIN KEY:</div>
      <input id="adminKey" style="min-width:260px;flex:1" placeholder="–≤—Å—Ç–∞–≤—å –∫–ª—é—á"/>
      <button id="saveCfg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="secondary" id="loadStats">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
    </div>
    <div id="cfgHint" class="muted" style="margin-top:10px;">
      –ö–ª—é—á –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ <span class="pill">X-Admin-Key</span>. –ù–µ –ø—É–±–ª–∏–∫—É–π admin.html —Å –∫–ª—é—á–æ–º –≤–Ω—É—Ç—Ä–∏.
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div id="statsStatus" class="muted"></div>
    </div>
    <div id="statsBox" class="row" style="margin-top:10px;gap:12px;"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
    <div class="row" style="margin-top:10px;">
      <input id="userId" placeholder="tg_user_id (—á–∏—Å–ª–æ)" style="min-width:240px;"/>
      <button id="loadUser">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <input id="delta" placeholder="delta (+100 / -50)" style="width:160px"/>
      <button class="secondary" id="applyDelta">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
      <div id="userStatus" class="muted"></div>
    </div>
    <div id="userBox" class="muted" style="margin-top:10px;"></div>
    <div id="userTables"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">üéÅ –ü—Ä–∏–∑—ã (CRUD)</div>
      <div class="row">
        <button class="secondary" id="loadPrizes">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <div id="prizesStatus" class="muted"></div>
      </div>
    </div>
    <div id="prizesBox"></div>
    <div class="muted" style="margin-top:8px;">
      –ü–æ–¥—Å–∫–∞–∑–∫–∞: <span class="pill">icon_url</span> –º–æ–∂–µ—Ç –±—ã—Ç—å PNG/WebP –∏–ª–∏ WebM. –î–ª—è WebM —Ä—è–¥–æ–º –ª—É—á—à–µ –ø–æ–ª–æ–∂–∏—Ç—å WebP —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º (poster).
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:900;">üí≥ Topups</div>
      <button class="secondary" id="loadTopups">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    <div id="topupsBox"></div>
  </div>
</div>

<script>
  const apiBaseEl = document.getElementById('apiBase');
  const adminKeyEl = document.getElementById('adminKey');

  const statsBox = document.getElementById('statsBox');
  const statsStatus = document.getElementById('statsStatus');

  const userIdEl = document.getElementById('userId');
  const deltaEl = document.getElementById('delta');
  const userStatus = document.getElementById('userStatus');
  const userBox = document.getElementById('userBox');
  const userTables = document.getElementById('userTables');

  const prizesBox = document.getElementById('prizesBox');
  const prizesStatus = document.getElementById('prizesStatus');

  const topupsBox = document.getElementById('topupsBox');

  function loadCfg() {
    apiBaseEl.value = localStorage.getItem('admin_api_base') || 'https://test-u2mr.onrender.com';
    adminKeyEl.value = localStorage.getItem('admin_key') || '';
  }

  function saveCfg() {
    localStorage.setItem('admin_api_base', apiBaseEl.value.trim());
    localStorage.setItem('admin_key', adminKeyEl.value.trim());
  }

  function fmtTime(ts) {
    if (!ts) return '';
    try { return new Date(ts * 1000).toLocaleString(); } catch (_) { return String(ts); }
  }

  async function api(path, opts={}) {
    const base = apiBaseEl.value.trim().replace(/\/$/, '');
    const key = adminKeyEl.value.trim();
    const res = await fetch(base + path, {
      ...opts,
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Key': key,
        ...(opts.headers || {})
      }
    });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch (_) { data = text; }
    if (!res.ok) throw new Error(\`HTTP \${res.status}: \${typeof data === 'string' ? data : JSON.stringify(data)}\`);
    return data;
  }

  function statCard(title, value) {
    const div = document.createElement('div');
    div.className = 'pill';
    div.style.padding = '10px 12px';
    div.innerHTML = \`<div class="muted" style="font-size:12px">\${title}</div><div style="font-weight:900;font-size:16px;margin-top:4px">\${value}</div>\`;
    return div;
  }

  async function loadStats() {
    statsStatus.textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
    statsBox.innerHTML = '';
    try {
      const s = await api('/admin/stats');
      statsBox.appendChild(statCard('Users', s.users));
      statsBox.appendChild(statCard('Total balance', s.total_balance));
      statsBox.appendChild(statCard('Spins total', s.spins_total));
      statsBox.appendChild(statCard('Spins 24h', s.spins_24h));
      statsBox.appendChild(statCard('Topups total', s.topups_total));
      statsBox.appendChild(statCard('Topups 24h', s.topups_24h));
      statsBox.appendChild(statCard('Paid stars total', s.paid_stars_total));
      statsBox.appendChild(statCard('Paid stars 24h', s.paid_stars_24h));
      statsStatus.innerHTML = \`<span class="ok">OK</span> ‚Ä¢ \${new Date().toLocaleTimeString()}\`;
    } catch (e) {
      statsStatus.innerHTML = \`<span class="bad">ERR</span> ‚Ä¢ \${e.message}\`;
    }
  }

  function renderTable(title, cols, rows) {
    const wrap = document.createElement('div');
    wrap.className = 'card';
    wrap.style.marginTop = '12px';
    wrap.style.background = '#0f1a2b';

    const h = document.createElement('div');
    h.style.fontWeight = '900';
    h.textContent = title;

    const t = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c;
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    const tbody = document.createElement('tbody');
    rows.forEach(r => {
      const tr = document.createElement('tr');
      r.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell ?? '';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    t.appendChild(thead);
    t.appendChild(tbody);

    wrap.appendChild(h);
    wrap.appendChild(t);
    return wrap;
  }

  async function loadUser() {
    const uid = userIdEl.value.trim();
    if (!uid) return;

    userStatus.textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
    userBox.textContent = '';
    userTables.innerHTML = '';

    try {
      const d = await api('/admin/user/' + encodeURIComponent(uid));

      userBox.innerHTML = `
        <div><span class="pill">tg_user_id</span> <b>${d.user.tg_user_id}</b></div>
        <div style="margin-top:6px;"><span class="pill">name</span> <b>${d.user.name || ''}</b></div>
        <div style="margin-top:6px;"><span class="pill">balance</span> <b>${d.user.balance}</b></div>
        <div style="margin-top:6px;"><span class="pill">created</span> ${fmtTime(d.user.created_at)}</div>
      `;

      const spinsRows = (d.spins || []).map(s => [
        s.created_at ? fmtTime(s.created_at) : '',
        s.spin_id,
        `${s.bet_cost}`,
        `${s.prize_name} (${s.prize_cost})`,
        s.status
      ]);
      userTables.appendChild(renderTable('Spins (last 30)', ['time','spin_id','bet','prize','status'], spinsRows));

      const invRows = (d.inventory || []).map(i => [
        i.created_at ? fmtTime(i.created_at) : '',
        `${i.prize_name}`,
        `${i.prize_cost}`
      ]);
      userTables.appendChild(renderTable('Inventory (last 30)', ['time','item','cost'], invRows));

      const topRows = (d.topups || []).map(t => [
        fmtTime(t.created_at),
        `${t.stars_amount}`,
        t.status,
        t.paid_at ? fmtTime(t.paid_at) : ''
      ]);
      userTables.appendChild(renderTable('Topups (last 30)', ['created','stars','status','paid_at'], topRows));

      userStatus.innerHTML = `<span class="ok">OK</span>`;
    } catch (e) {
      userStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  }

  async function applyDelta() {
    const uid = userIdEl.value.trim();
    const delta = parseInt(deltaEl.value.trim(), 10);
    if (!uid || !Number.isFinite(delta)) {
      alert('–£–∫–∞–∂–∏ tg_user_id –∏ delta (—á–∏—Å–ª–æ).');
      return;
    }
    userStatus.textContent = '–ø—Ä–∏–º–µ–Ω—è—é...';
    try {
      const res = await api('/admin/adjust_balance', {
        method: 'POST',
        body: JSON.stringify({ tg_user_id: uid, delta })
      });
      userStatus.innerHTML = `<span class="ok">OK</span> ‚Ä¢ new balance: ${res.balance}`;
      await loadUser();
      await loadStats();
    } catch (e) {
      userStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  }

  function tdInput(value, widthPx=120) {
    const inp = document.createElement('input');
    inp.value = value ?? '';
    inp.style.width = widthPx + 'px';
    inp.className = 'mini';
    return inp;
  }

  function tdCheckbox(checked) {
    const inp = document.createElement('input');
    inp.type = 'checkbox';
    inp.checked = !!checked;
    return inp;
  }

  async function loadPrizes() {
    prizesStatus.textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
    prizesBox.innerHTML = '';
    try {
      const d = await api('/admin/prizes');
      const items = (d.items || []);

      const t = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>ID</th>
          <th>name</th>
          <th>cost</th>
          <th>weight</th>
          <th>icon_url</th>
          <th>active</th>
          <th>sort</th>
          <th>actions</th>
        </tr>
      `;
      const tbody = document.createElement('tbody');

      // Create row
      const trNew = document.createElement('tr');
      const newId = tdInput('', 70);
      const newName = tdInput('', 220);
      const newCost = tdInput('25', 80);
      const newWeight = tdInput('10', 80);
      const newIcon = tdInput('', 360);
      const newActive = tdCheckbox(true);
      const newSort = tdInput('0', 70);

      const btnCreate = document.createElement('button');
      btnCreate.textContent = 'Create';
      btnCreate.className = 'mini';
      btnCreate.onclick = async () => {
        btnCreate.disabled = true;
        try {
          const payload = {
            id: newId.value.trim() ? parseInt(newId.value.trim(),10) : null,
            name: newName.value.trim(),
            cost: parseInt(newCost.value.trim(),10) || 0,
            weight: parseInt(newWeight.value.trim(),10) || 0,
            icon_url: newIcon.value.trim() || null,
            is_active: !!newActive.checked,
            sort_order: parseInt(newSort.value.trim(),10) || 0
          };
          if (!payload.name) return alert('name –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
          await api('/admin/prizes', { method:'POST', body: JSON.stringify(payload) });
          prizesStatus.innerHTML = `<span class="ok">OK</span> created`;
          await loadPrizes();
        } catch (e) {
          prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
        } finally {
          btnCreate.disabled = false;
        }
      };

      // manual cells
      const td1 = document.createElement('td'); td1.appendChild(newId); trNew.appendChild(td1);
      const td2 = document.createElement('td'); td2.appendChild(newName); trNew.appendChild(td2);
      const td3 = document.createElement('td'); td3.appendChild(newCost); trNew.appendChild(td3);
      const td4 = document.createElement('td'); td4.appendChild(newWeight); trNew.appendChild(td4);
      const td5 = document.createElement('td'); td5.appendChild(newIcon); trNew.appendChild(td5);
      const td6 = document.createElement('td'); td6.appendChild(newActive); trNew.appendChild(td6);
      const td7 = document.createElement('td'); td7.appendChild(newSort); trNew.appendChild(td7);
      const td8 = document.createElement('td'); td8.appendChild(btnCreate); trNew.appendChild(td8);

      tbody.appendChild(trNew);

      // Existing rows
      items.forEach(p => {
        const tr = document.createElement('tr');

        const id = p.id;

        const inpName = tdInput(p.name, 220);
        const inpCost = tdInput(p.cost, 80);
        const inpWeight = tdInput(p.weight, 80);
        const inpIcon = tdInput(p.icon_url || '', 360);
        const inpActive = tdCheckbox(p.is_active);
        const inpSort = tdInput(p.sort_order, 70);

        const btnSave = document.createElement('button');
        btnSave.textContent = 'Save';
        btnSave.className = 'mini';
        btnSave.onclick = async () => {
          btnSave.disabled = true;
          try {
            const payload = {
              id,
              name: inpName.value.trim(),
              cost: parseInt(inpCost.value.trim(),10) || 0,
              weight: parseInt(inpWeight.value.trim(),10) || 0,
              icon_url: inpIcon.value.trim() || null,
              is_active: !!inpActive.checked,
              sort_order: parseInt(inpSort.value.trim(),10) || 0
            };
            if (!payload.name) return alert('name –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
            await api('/admin/prizes/' + encodeURIComponent(id), { method:'PUT', body: JSON.stringify(payload) });
            prizesStatus.innerHTML = `<span class="ok">OK</span> saved #${id}`;
          } catch (e) {
            prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
          } finally {
            btnSave.disabled = false;
          }
        };

        const btnDel = document.createElement('button');
        btnDel.textContent = 'Delete';
        btnDel.className = 'mini danger';
        btnDel.onclick = async () => {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∑ #' + id + '?')) return;
          btnDel.disabled = true;
          try {
            await api('/admin/prizes/' + encodeURIComponent(id), { method:'DELETE' });
            prizesStatus.innerHTML = `<span class="ok">OK</span> deleted #${id}`;
            await loadPrizes();
          } catch (e) {
            prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
          } finally {
            btnDel.disabled = false;
          }
        };

        const tdId = document.createElement('td'); tdId.textContent = String(id); tr.appendChild(tdId);
        const tdName = document.createElement('td'); tdName.appendChild(inpName); tr.appendChild(tdName);
        const tdCost = document.createElement('td'); tdCost.appendChild(inpCost); tr.appendChild(tdCost);
        const tdW = document.createElement('td'); tdW.appendChild(inpWeight); tr.appendChild(tdW);
        const tdIcon = document.createElement('td'); tdIcon.appendChild(inpIcon); tr.appendChild(tdIcon);
        const tdAct = document.createElement('td'); tdAct.appendChild(inpActive); tr.appendChild(tdAct);
        const tdSort = document.createElement('td'); tdSort.appendChild(inpSort); tr.appendChild(tdSort);

        const tdActions = document.createElement('td');
        tdActions.appendChild(btnSave);
        tdActions.appendChild(document.createTextNode(' '));
        tdActions.appendChild(btnDel);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });

      t.appendChild(thead);
      t.appendChild(tbody);
      prizesBox.appendChild(t);

      prizesStatus.innerHTML = `<span class="ok">OK</span> ‚Ä¢ ${items.length} items`;
    } catch (e) {
      prizesStatus.innerHTML = `<span class="bad">ERR</span> ‚Ä¢ ${e.message}`;
    }
  }

  async function loadTopups() {
    topupsBox.innerHTML = '<div class="muted">–∑–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
      const d = await api('/admin/topups?limit=80');
      const rows = (d.items || []).map(t => ([
        fmtTime(t.created_at),
        t.tg_user_id,
        `${t.stars_amount}`,
        t.status,
        t.paid_at ? fmtTime(t.paid_at) : ''
      ]));

      topupsBox.innerHTML = '';
      topupsBox.appendChild(renderTable('Topups', ['created','user','stars','status','paid_at'], rows));
    } catch (e) {
      topupsBox.innerHTML = `<div class="bad">ERR: ${e.message}</div>`;
    }
  }

  document.getElementById('saveCfg').onclick = () => { saveCfg(); loadStats(); };
  document.getElementById('loadStats').onclick = loadStats;
  document.getElementById('loadUser').onclick = loadUser;
  document.getElementById('applyDelta').onclick = applyDelta;
  document.getElementById('loadTopups').onclick = loadTopups;
  document.getElementById('loadPrizes').onclick = loadPrizes;

  loadCfg();
  loadStats();
  loadPrizes();
</script>
</body>
</html>
